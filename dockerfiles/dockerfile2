
# Stage 1: Build stage
FROM ubuntu:24.04 AS builder
LABEL maintainer="Kari Salokas kari.salokas@helsinki.fi"

ENV DEBIAN_FRONTEND=noninteractive \
    LC_ALL=en_US.UTF-8 \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    MAMBA_ROOT_PREFIX=/opt/conda \
    RENV_CONFIG_EXTERNAL_LIBRARIES="" \
    R_LIBS_SITE="" \
    R_LIBS_USER="" \
    RENV_PATHS_CACHE=/opt/renv/cache

# Install build dependencies and chrome
RUN apt-get update && \
    apt-get install -yq --no-install-recommends \
        wget \
        locales \
        software-properties-common \
        dirmngr \
        xz-utils \
        cron \
        apt-utils \
        git \
        curl \
        python3 \
        python3-pip \
        gnupg && \
    locale-gen en_US.UTF-8 && \
    update-locale LANG=en_US.UTF-8 && \
    # Install Node.js 18.x (LTS) for compatibility
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -yq --no-install-recommends nodejs && \
    # Add R repositories
    echo "deb https://cloud.r-project.org/bin/linux/ubuntu noble-cran40/" > /etc/apt/sources.list.d/cran.list && \
    wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | gpg --dearmor > /etc/apt/trusted.gpg.d/cran.gpg && \
    echo "deb [arch=amd64] https://r2u.stat.illinois.edu/ubuntu noble main" > /etc/apt/sources.list.d/cranapt.list && \
    wget -qO- https://eddelbuettel.github.io/r2u/assets/dirk_eddelbuettel_key.asc | gpg --dearmor > /etc/apt/trusted.gpg.d/cranapt.gpg && \
    apt-get update && \
    # Install Chrome and its dependencies
    wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb && \
    apt-get install -yq --no-install-recommends ./google-chrome-stable_current_amd64.deb && \
    rm -f google-chrome-stable_current_amd64.deb && \
    # Install R and other dependencies
    apt-get install -yq --no-install-recommends \
        r-base \
        r-base-dev \
        r-recommended \
        littler \
        libcurl4-openssl-dev \
        libxml2-dev \
        libblas-dev \
        libfontconfig1-dev \
        libharfbuzz-dev \
        libfribidi-dev \
        gfortran \
        libfreetype6-dev \
        libpng-dev \
        liblapack-dev \
        libfftw3-dev \
        libtiff5-dev \
        libjpeg-dev \
        libssl-dev \
        libgit2-dev \
        libicu-dev \
        postgresql \
        redis \
        psmisc \
        ca-certificates && \
    rm -rf /var/lib/apt/lists/* && \
    npm install -g configurable-http-proxy


# Install R packages
WORKDIR /proteogyver
COPY requirements/renv.lock .
RUN R --vanilla -q -e "install.packages('renv', repos='https://cloud.r-project.org')" && \
    R --vanilla -q -e "renv::restore(prompt = FALSE, clean = TRUE)" && \
    rm -rf /opt/renv/cache/*.tar.gz /opt/renv/cache/*.zip 2>/dev/null || true

# Install micromamba and create environment
COPY requirements/environment.yml .
RUN curl -L https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj -C /usr/local/bin --strip-components=1 bin/micromamba && \
    micromamba shell init -s bash -r ${MAMBA_ROOT_PREFIX} && \
    micromamba create -y -n PG -f environment.yml && \
    micromamba clean -a -y && \
    find /opt/conda -type f -name "*.pyc" -delete && \
    find /opt/conda -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/conda -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/conda -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/conda -type d -name "test" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/conda -type f -name "*.a" -delete && \
    find /opt/conda -type f -name "*.la" -delete

# Copy app code (needed for SAINTexpress executables)
COPY app /proteogyver/app

# Clean up Python cache files and create SAINTexpress symlinks
RUN find /proteogyver/app -type f -name "*.pyc" -delete && \
    find /proteogyver/app -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
    find /proteogyver/app -type f -name "*.ipynb" -delete && \
    find /proteogyver/app -type d -name "*.ipynb_checkpoints" -exec rm -rf {} + 2>/dev/null || true && \
    rm -rf /proteogyver/app/cache /proteogyver/app/logs /proteogyver/app/debug && \
    if [ -f /proteogyver/app/external/SAINTexpress/SAINTexpress-spc ]; then \
        chmod 777 /proteogyver/app/external/SAINTexpress/SAINTexpress-spc && \
        ln -s /proteogyver/app/external/SAINTexpress/SAINTexpress-spc /usr/bin/SAINTexpressSpc; \
    fi && \
    if [ -f /proteogyver/app/external/SAINTexpress/SAINTexpress-int ]; then \
        chmod 777 /proteogyver/app/external/SAINTexpress/SAINTexpress-int && \
        ln -s /proteogyver/app/external/SAINTexpress/SAINTexpress-int /usr/bin/SAINTexpressInt; \
    fi

# Stage 2: Runtime stage
FROM ubuntu:24.04
LABEL maintainer="Kari Salokas kari.salokas@helsinki.fi"

# Copy only necessary files from builder
COPY --from=builder /opt/conda /opt/conda
COPY --from=builder /opt/renv /opt/renv
COPY --from=builder /proteogyver /proteogyver
COPY --from=builder /usr/bin/google-chrome* /usr/bin/
COPY --from=builder /usr/bin/SAINTexpressSpc /usr/bin/SAINTexpressSpc
COPY --from=builder /usr/bin/SAINTexpressInt /usr/bin/SAINTexpressInt

# Install Node.js and configurable-http-proxy in runtime stage
RUN apt-get update && \
    apt-get install -yq --no-install-recommends \
        curl \
        ca-certificates && \
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -yq --no-install-recommends nodejs && \
    npm install -g --production configurable-http-proxy && \
    npm cache clean --force && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /root/.npm

# Final cleanup in runtime stage
RUN find /proteogyver -type f -name "*.pyc" -delete && \
    find /proteogyver -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
    find /proteogyver -type f -name "*.ipynb" -delete && \
    find /opt/conda -type f -name "*.pyc" -delete && \
    find /opt/conda -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
    rm -rf /proteogyver/app/cache /proteogyver/app/logs /proteogyver/app/debug /tmp/* /var/tmp/*

# Set environment variables
ENV PATH="/opt/conda/envs/PG/bin:/usr/local/bin:${PATH}" \
    DEBIAN_FRONTEND=noninteractive \
    LC_ALL=en_US.UTF-8 \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    MAMBA_ROOT_PREFIX=/opt/conda \
    RENV_CONFIG_EXTERNAL_LIBRARIES="" \
    R_LIBS_SITE="" \
    R_LIBS_USER="" \
    RENV_PATHS_CACHE=/opt/renv/cache \
    PRE_LOAD_CHROME='False'

# Expose ports
EXPOSE 8090 8050

# Copy entrypoint and set permissions
COPY dockerfiles/docker_entrypoint.sh /docker_entrypoint.sh
COPY VERSION /VERSION
COPY LICENSE /LICENSE
RUN chmod +x /docker_entrypoint.sh

WORKDIR /proteogyver
ENTRYPOINT ["/bin/bash", "/docker_entrypoint.sh"]
