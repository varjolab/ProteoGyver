
# Stage 1: Build stage
FROM ubuntu:24.04 AS builder
LABEL maintainer="Kari Salokas kari.salokas@helsinki.fi"

ENV DEBIAN_FRONTEND=noninteractive \
    LC_ALL=en_US.UTF-8 \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    MAMBA_ROOT_PREFIX=/opt/conda \
    RENV_CONFIG_EXTERNAL_LIBRARIES="" \
    R_LIBS_SITE="" \
    R_LIBS_USER="" \
    RENV_PATHS_CACHE=/opt/renv/cache

# Install build dependencies for R
RUN apt-get update && \
    apt-get install -yq --no-install-recommends \
        wget \
        locales \
        software-properties-common \
        dirmngr \
        xz-utils \
        cron \
        apt-utils \
        git \
        curl \
        python3 \
        python3-pip \
        gnupg \
        fonts-liberation \
        libasound2 \
        libatk-bridge2.0-0 \
        libatk1.0-0 \
        libatspi2.0-0 \
        libcups2 \
        libdbus-1-3 \
        libdrm2 \
        libgbm1 \
        libgtk-3-0 \
        libnspr4 \
        libnss3 \
        libxcomposite1 \
        libxdamage1 \
        libxfixes3 \
        libxkbcommon0 \
        libxrandr2 \
        xdg-utils \
        build-essential \
        fort77 \
        libreadline-dev \
        libbz2-dev \
        liblzma-dev \
        libpcre2-dev \
        libcurl4-openssl-dev \
        libssl-dev \
        libicu-dev \
        libtiff-dev \
        && \
    locale-gen en_US.UTF-8 && \
    update-locale LANG=en_US.UTF-8 && \
    # Install Node.js 20.x
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -yq --no-install-recommends nodejs && \
    # Install Chrome
    wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb && \
    apt-get install -yq --no-install-recommends ./google-chrome-stable_current_amd64.deb && \
    rm -f google-chrome-stable_current_amd64.deb && \
    # Build R from source
    wget -q https://cran.r-project.org/src/base/R-4/R-4.3.2.tar.gz && \
    tar -xzf R-4.3.2.tar.gz && \
    cd R-4.3.2 && \
    ./configure --enable-R-shlib --with-blas --with-lapack --with-libpng --with-libtiff --with-icu && \
    make -j$(nproc) && \
    make install && \
    cd .. && \
    rm -rf R-4.3.2 R-4.3.2.tar.gz && \
    rm -rf /var/lib/apt/lists/* && \
    npm install -g configurable-http-proxy


# Install R packages
WORKDIR /proteogyver
COPY requirements/renv.lock .
RUN R --vanilla -q -e "install.packages('renv', repos='https://cloud.r-project.org')" && \
    R --vanilla -q -e "renv::restore(prompt = FALSE, clean = TRUE)"

# Install micromamba and create environment
COPY requirements/environment.yml .
RUN curl -L https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj -C /usr/local/bin --strip-components=1 bin/micromamba && \
    micromamba shell init -s bash -r ${MAMBA_ROOT_PREFIX} && \
    micromamba create -y -n PG -f environment.yml && \
    micromamba clean -a -y

# Stage 2: Runtime stage
FROM ubuntu:24.04
LABEL maintainer="Kari Salokas kari.salokas@helsinki.fi"

# Copy only necessary files from builder
COPY --from=builder /opt/conda /opt/conda
COPY --from=builder /opt/renv /opt/renv
COPY --from=builder /proteogyver /proteogyver
COPY --from=builder /usr/bin/google-chrome* /usr/bin/
COPY --from=builder /usr/bin/SAINTexpressSpc /usr/bin/SAINTexpressSpc
COPY --from=builder /usr/bin/SAINTexpressInt /usr/bin/SAINTexpressInt
COPY --from=builder /usr/local/bin/configurable-http-proxy /usr/local/bin/configurable-http-proxy

# Set environment variables
ENV PATH="/opt/conda/envs/PG/bin:${PATH}" \
    DEBIAN_FRONTEND=noninteractive \
    LC_ALL=en_US.UTF-8 \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    MAMBA_ROOT_PREFIX=/opt/conda \
    RENV_CONFIG_EXTERNAL_LIBRARIES="" \
    R_LIBS_SITE="" \
    R_LIBS_USER="" \
    RENV_PATHS_CACHE=/opt/renv/cache \
    PRE_LOAD_CHROME='False'

# Expose ports
EXPOSE 8090 8050

# Copy entrypoint and set permissions
COPY dockerfiles/docker_entrypoint.sh /docker_entrypoint.sh
COPY VERSION /VERSION
COPY LICENSE /LICENSE
RUN chmod +x /docker_entrypoint.sh

WORKDIR /proteogyver
ENTRYPOINT ["/bin/bash", "/docker_entrypoint.sh"]
