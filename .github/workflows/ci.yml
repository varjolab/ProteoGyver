name: CI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    name: e2e (conda environment)
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          micromamba-version: 'latest'
          environment-file: requirements/environment.yml
          create-args: >-
            -n PG
          cache-environment: true
          cache-downloads: true

      - name: Show environment
        run: |
          micromamba info
          micromamba list

      - name: Prepare R user library
        run: |
          R_LIBS_USER="${RUNNER_TEMP}/R/renv"
          echo "R_LIBS_USER=${R_LIBS_USER}" >> $GITHUB_ENV
          mkdir -p "${R_LIBS_USER}"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            software-properties-common \
            dirmngr \
            wget \
            xz-utils \
            cron \
            apt-utils \
            ca-certificates \
            nano \
            postgresql \
            littler \
            gnupg \
            build-essential \
            gfortran \
            libblas-dev \
            liblapack-dev \
            libcurl4-openssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev \
            libssl-dev \
            libgit2-dev \
            libicu-dev

      - name: Set up R repositories
        run: |
          wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | sudo tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc
          sudo add-apt-repository "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/"
          wget -q -O- https://eddelbuettel.github.io/r2u/assets/dirk_eddelbuettel_key.asc | sudo tee -a /etc/apt/trusted.gpg.d/cranapt_key.asc
          echo "deb [arch=amd64] https://r2u.stat.illinois.edu/ubuntu jammy main" | sudo tee /etc/apt/sources.list.d/cranapt.list
          sudo apt-get update
          sudo apt-get install -y \
            r-cran-littler \
            r-base \
            r-base-dev \
            r-recommended

      - name: Install CRAN packages into user library (littler)
        run: |
          # Install CRAN packages directly into the job user library path
          install2.r -l "${R_LIBS_USER}" -s imputeLCMD randomForest readr || true

      - name: Install Bioconductor packages into user library (littler)
        run: |
          # vsn is a Bioconductor package
          installBioc.r -l "${R_LIBS_USER}" vsn || true

      - name: Verify Python
        run: |
          micromamba run -n PG python -V

      - name: Install R packages via renv lockfile
        run: |
          # Use a user-writable library for R packages
          R -q -e "dir.create(Sys.getenv('R_LIBS_USER'), recursive=TRUE, showWarnings=FALSE); install.packages('renv', repos='https://cloud.r-project.org', lib=Sys.getenv('R_LIBS_USER'))"
          R -q -e ".libPaths(c(Sys.getenv('R_LIBS_USER'), .libPaths())); Sys.setenv(RENV_PATHS_LIBRARY=Sys.getenv('R_LIBS_USER'), RENV_CONFIG_REPOS_OVERRIDE='https://cloud.r-project.org'); renv::restore(lockfile = 'requirements/renv.lock', prompt = FALSE, clean = TRUE)"

      - name: R diagnostics (libraries, versions, load tests)
        run: |
          R -q -e ".libPaths(); cat('R_LIBS_USER=', Sys.getenv('R_LIBS_USER'), '\n')"
          R -q -e "ip <- as.data.frame(installed.packages()[,c('Package','LibPath','Version')]); print(ip[ip$Package %in% c('imputeLCMD','vsn','randomForest','readr'), ])"
          R -q -e "for (p in c('imputeLCMD','vsn','randomForest','readr')) { cat('Loading ', p, ' ... '); tryCatch({ library(p, character.only=TRUE); cat('ok\n'); print(packageVersion(p)) }, error=function(e) { cat('FAILED: ', conditionMessage(e), '\n') }) }"

      - name: Set up test environment
        run: |
          mkdir -p /tmp/proteogyver/data/Server_output
          mkdir -p /tmp/proteogyver/data/Server_input
          mkdir -p /tmp/proteogyver/data/Server_output/logs
          echo "PROTEOGYVER_DATA_DIR=/tmp/proteogyver/data" >> $GITHUB_ENV

      - name: Unpack minimal database
        run: |
          if [ -f app/data/minimal_pg_db.sqlite3.xz ]; then \
            echo "Found compressed DB. Unpacking..."; \
            xz -d -f app/data/minimal_pg_db.sqlite3.xz; \
          fi

      - name: Run e2e tests
        env:
          R_LIBS_USER: ${{ env.R_LIBS_USER }}
        run: |
          mkdir -p reports
          micromamba run -n PG pytest -q tests/e2e/test_pipeline.py -m e2e --maxfail=1 --disable-warnings --junitxml=reports/junit.xml

      - name: Upload JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: reports/junit.xml