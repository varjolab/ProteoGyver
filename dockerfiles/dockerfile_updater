# Use a slim Python base image to reduce size
FROM python:3.12-slim

# Set environment variables to reduce buffer issues and avoid pip cache
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1

    # Set the working directory in the container
WORKDIR /proteogyver

RUN mkdir -p /proteogyver/data/Server_output /proteogyver/data/Server_input /proteogyver/data/Server_output/logs
# Requirement and config
COPY requirements/updater_requirements.txt requirements.txt
COPY app/config/parameters.toml /proteogyver/parameters.toml
COPY app/resources /proteogyver/resources

# Python deps (wheels) â€” avoid apt build tools to keep image small
RUN apt-get update \
    && apt-get install -y --no-install-recommends ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && pip install --upgrade pip \
    && pip install --no-cache-dir -r requirements.txt

# Decompress the minimal database (install xz-utils temporarily and purge afterwards)
COPY app/data/minimal_pg_db.sqlite3.xz /proteogyver/data/minimal_pg_db.sqlite3.xz
RUN apt-get update \
    && apt-get install -y --no-install-recommends xz-utils \
    && unxz /proteogyver/data/minimal_pg_db.sqlite3.xz \
    && apt-get purge -y --auto-remove xz-utils \
    && rm -rf /var/lib/apt/lists/*

# Main scripts
COPY app/database_updater.py database_updater.py
COPY app/database_admin.py database_admin.py
# Needed extras
COPY app/components/text_handling.py components/text_handling.py
COPY app/components/db_functions.py components/db_functions.py
COPY app/components/api_tools components/api_tools
COPY app/components/tools/utils.py components/tools/utils.py


# Copy minimal updater entrypoint script
COPY dockerfiles/updater_entrypoint.sh /proteogyver/updater_entrypoint.sh
RUN chmod +x /proteogyver/updater_entrypoint.sh

# Use minimal bash entrypoint for updater
ENTRYPOINT ["/bin/bash", "/proteogyver/updater_entrypoint.sh"]
