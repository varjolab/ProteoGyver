

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>app.components.parsing &mdash; ProteoGyver Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=aaadad1f"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ProteoGyver
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../code/modules.html">2025_ProteoGyver</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ProteoGyver</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">app.components.parsing</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for app.components.parsing</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;File parsing functions for ProteoGyver.</span>

<span class="sd">Functions for parsing and processing various data formats, handling data</span>
<span class="sd">type conversions, and managing parameter configurations used throughout</span>
<span class="sd">the application.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">components</span><span class="w"> </span><span class="kn">import</span> <span class="n">db_functions</span><span class="p">,</span> <span class="n">text_handling</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">components</span><span class="w"> </span><span class="kn">import</span> <span class="n">EnrichmentAdmin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">components.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>

<div class="viewcode-block" id="update_nested_dict">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.update_nested_dict">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_nested_dict</span><span class="p">(</span><span class="n">base_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">update_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update a nested dictionary with values from another.</span>

<span class="sd">    :param base_dict: Base dictionary to update.</span>
<span class="sd">    :param update_dict: Dictionary containing update values.</span>
<span class="sd">    :returns: Updated base dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">update_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">base_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_nested_dict</span><span class="p">(</span><span class="n">base_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">base_dict</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_to_str</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">nan_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">float_precision</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a string representation of numeric or string values.</span>

<span class="sd">    :param val: Value to convert to string.</span>
<span class="sd">    :param nan_str: Replacement for NaN values.</span>
<span class="sd">    :param float_precision: Decimal places for float formatting.</span>
<span class="sd">    :returns: String representation of the value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">nan_str</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s1">.</span><span class="si">{</span><span class="n">float_precision</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span>

<div class="viewcode-block" id="check_numeric">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.check_numeric">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_numeric</span><span class="p">(</span><span class="n">st</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a string can be converted to a numeric value.</span>

<span class="sd">    :param st: String or numpy number to check for numeric conversion.</span>
<span class="sd">    :returns: Dict with keys ``success`` and ``value`` (converted value or original string).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">st</span><span class="p">}</span>
    <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sts</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;0&#39;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">st</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span></div>


<div class="viewcode-block" id="unmix_dtypes">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.unmix_dtypes">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unmix_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert mixed dtype columns in a dataframe to strings in place.</span>

<span class="sd">    :param df: DataFrame to process.</span>
<span class="sd">    :raises TypeError: If conversion still results in mixed dtype.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">orig_dtype</span> <span class="o">:=</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">infer_dtype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;mixed&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_to_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">new_dtype</span> <span class="o">:=</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">infer_dtype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;mixed&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to convert </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> to a non-mixed dtype. Its previous dtype was </span><span class="si">{</span><span class="n">orig_dtype</span><span class="si">}</span><span class="s2"> and new dtype is </span><span class="si">{</span><span class="n">new_dtype</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_parameters">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.parse_parameters">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_parameters</span><span class="p">(</span><span class="n">parameters_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse and enrich parameters from a TOML configuration file.</span>

<span class="sd">    :param parameters_file: Path to parameters TOML file.</span>
<span class="sd">    :returns: Enriched parameters dictionary (controls, CRAPome, enrichment).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_toml</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">parameters_file</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Data paths&#39;</span><span class="p">][</span><span class="s1">&#39;Database file&#39;</span><span class="p">])):</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Data paths&#39;</span><span class="p">][</span><span class="s1">&#39;Database file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Data paths&#39;</span><span class="p">][</span><span class="s1">&#39;Minimal database file&#39;</span><span class="p">]</span>
    
    <span class="n">db_conn</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Data paths&#39;</span><span class="p">][</span><span class="s1">&#39;Database file&#39;</span><span class="p">]))</span>
    <span class="n">control_sets</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">get_from_table</span><span class="p">(</span>
        <span class="n">db_conn</span><span class="p">,</span> <span class="s1">&#39;control_sets&#39;</span><span class="p">,</span> <span class="n">select_col</span><span class="o">=</span><span class="s1">&#39;control_set_name&#39;</span><span class="p">)</span>
    <span class="n">default_control_sets</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">get_from_table</span><span class="p">(</span>
        <span class="n">db_conn</span><span class="p">,</span>
        <span class="s1">&#39;control_sets&#39;</span><span class="p">,</span>
        <span class="s1">&#39;control_set_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_default&#39;</span><span class="p">,</span>
        <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">disabled_control_sets</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">get_from_table</span><span class="p">(</span>
        <span class="n">db_conn</span><span class="p">,</span>
        <span class="s1">&#39;control_sets&#39;</span><span class="p">,</span>
        <span class="s1">&#39;control_set_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_disabled&#39;</span><span class="p">,</span>
        <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">crapome_sets</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">get_from_table</span><span class="p">(</span>
        <span class="n">db_conn</span><span class="p">,</span> <span class="s1">&#39;crapome_sets&#39;</span><span class="p">,</span> <span class="n">select_col</span><span class="o">=</span><span class="s1">&#39;crapome_set_name&#39;</span><span class="p">)</span>
    <span class="n">default_crapome_sets</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">get_from_table</span><span class="p">(</span>
        <span class="n">db_conn</span><span class="p">,</span>
        <span class="s1">&#39;crapome_sets&#39;</span><span class="p">,</span>
        <span class="s1">&#39;crapome_set_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_default&#39;</span><span class="p">,</span>
        <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">disabled_crapome_sets</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">get_from_table</span><span class="p">(</span>
        <span class="n">db_conn</span><span class="p">,</span>
        <span class="s1">&#39;crapome_sets&#39;</span><span class="p">,</span>
        <span class="s1">&#39;crapome_set_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_disabled&#39;</span><span class="p">,</span>
        <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">db_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;interactomics&#39;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;workflow parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;workflow parameters&#39;</span><span class="p">][</span><span class="s1">&#39;interactomics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;workflow parameters&#39;</span><span class="p">][</span><span class="s1">&#39;interactomics&#39;</span><span class="p">][</span><span class="s1">&#39;crapome&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;available&#39;</span><span class="p">:</span> <span class="n">crapome_sets</span><span class="p">,</span>
        <span class="s1">&#39;disabled&#39;</span><span class="p">:</span> <span class="n">disabled_crapome_sets</span><span class="p">,</span>
        <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">default_crapome_sets</span>
    <span class="p">}</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;workflow parameters&#39;</span><span class="p">][</span><span class="s1">&#39;interactomics&#39;</span><span class="p">][</span><span class="s1">&#39;controls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;available&#39;</span><span class="p">:</span> <span class="n">control_sets</span><span class="p">,</span>
        <span class="s1">&#39;disabled&#39;</span><span class="p">:</span> <span class="n">disabled_control_sets</span><span class="p">,</span>
        <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">default_control_sets</span>
    <span class="p">}</span>
    <span class="n">ea</span> <span class="o">=</span> <span class="n">EnrichmentAdmin</span><span class="o">.</span><span class="n">EnrichmentAdmin</span><span class="p">(</span><span class="n">parameters_file</span><span class="p">)</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;workflow parameters&#39;</span><span class="p">][</span><span class="s1">&#39;interactomics&#39;</span><span class="p">][</span><span class="s1">&#39;enrichment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;available&#39;</span><span class="p">:</span> <span class="n">ea</span><span class="o">.</span><span class="n">get_available</span><span class="p">(),</span>
        <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">ea</span><span class="o">.</span><span class="n">get_default</span><span class="p">(),</span>
        <span class="s1">&#39;disabled&#39;</span><span class="p">:</span> <span class="n">ea</span><span class="o">.</span><span class="n">get_disabled</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">parameters</span></div>



<div class="viewcode-block" id="get_distribution_title">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.get_distribution_title">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_distribution_title</span><span class="p">(</span><span class="n">used_table_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets appropriate title for value distribution plots.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        used_table_type (str): Type of table being plotted</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Plot title indicating value type and transformation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">used_table_type</span> <span class="o">==</span> <span class="s1">&#39;intensity&#39;</span><span class="p">:</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Log2 transformed value distribution&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Value distribution&#39;</span>
    <span class="k">return</span> <span class="n">title</span></div>



<div class="viewcode-block" id="read_dia_nn">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.read_dia_nn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_dia_nn</span><span class="p">(</span><span class="n">data_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads DIA-NN report file into an intensity matrix.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        data_table (pd.DataFrame): Raw DIA-NN data table</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        list: Contains:</span>
<span class="sd">            - pd.DataFrame: Processed intensity matrix</span>
<span class="sd">            - pd.DataFrame: Empty placeholder table</span>
<span class="sd">            - dict: Protein length information if available</span>
<span class="sd">            </span>
<span class="sd">    Notes:</span>
<span class="sd">        - Handles both report and matrix formats</span>
<span class="sd">        - Extracts protein length information</span>
<span class="sd">        - Replaces zeros with NaN values</span>
<span class="sd">        - Pivots data if in report format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">protein_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Protein.Group&#39;</span>
    <span class="n">protein_lengths</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;Protein Length&#39;</span> <span class="ow">in</span> <span class="n">data_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">protein_lengths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_table</span><span class="p">[[</span><span class="n">protein_col</span><span class="p">,</span> <span class="s1">&#39;Protein Length&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">protein_lengths</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">protein_col</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Protein Length&#39;</span><span class="p">]</span>
    <span class="n">is_report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="s1">&#39;Run&#39;</span><span class="p">:</span>
            <span class="n">is_report</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">is_report</span><span class="p">:</span>
        <span class="n">table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data_table</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">protein_col</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Run&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;PG.MaxLFQ&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_cols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">col</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
                <span class="n">data_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gather</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gather</span><span class="p">:</span>
                    <span class="n">data_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">column</span> <span class="o">==</span> <span class="s1">&#39;First.Protein.Description&#39;</span><span class="p">:</span>
                    <span class="n">gather</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">data_table</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span>
        <span class="n">table</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">data_table</span><span class="p">[</span><span class="s1">&#39;Protein.Group&#39;</span><span class="p">]</span>
    <span class="c1"># Replace zeroes with missing values</span>
    <span class="n">table</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">table</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;No data&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;No data&#39;</span><span class="p">]}),</span> <span class="n">protein_lengths</span><span class="p">]</span></div>



<div class="viewcode-block" id="read_fragpipe">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.read_fragpipe">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_fragpipe</span><span class="p">(</span><span class="n">data_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads FragPipe report into spectral count and intensity tables.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        data_table (pd.DataFrame): Raw FragPipe data table</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: Contains:</span>
<span class="sd">            - pd.DataFrame: Intensity table</span>
<span class="sd">            - pd.DataFrame: Spectral count table</span>
<span class="sd">            - dict: Protein length information if available</span>
<span class="sd">            </span>
<span class="sd">    Notes:</span>
<span class="sd">        - Identifies intensity and spectral count columns</span>
<span class="sd">        - Handles unique peptide counts</span>
<span class="sd">        - Supports MaxLFQ intensity values</span>
<span class="sd">        - Replaces zeros with NaN values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intensity_cols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spc_cols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">uniq_intensity_cols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">uniq_spc_cols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">has_maxlfq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;Total&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="s1">&#39;Combined&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="s1">&#39;Intensity&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;maxlfq&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">has_maxlfq</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;unique&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">uniq_intensity_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">intensity_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;Spectral Count&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;unique&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">uniq_spc_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spc_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniq_intensity_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">intensity_cols</span> <span class="o">=</span> <span class="n">uniq_intensity_cols</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniq_spc_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">spc_cols</span> <span class="o">=</span> <span class="n">uniq_spc_cols</span>
    <span class="k">if</span> <span class="n">has_maxlfq</span><span class="p">:</span>
        <span class="n">intensity_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">intensity_cols</span> <span class="k">if</span> <span class="s1">&#39;maxlfq&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="n">protein_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Protein ID&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;Protein Length&#39;</span> <span class="ow">in</span> <span class="n">data_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">protein_lengths</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_table</span><span class="p">[[</span><span class="n">protein_col</span><span class="p">,</span> <span class="s1">&#39;Protein Length&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">protein_lengths</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">protein_col</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Protein Length&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">protein_lengths</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">data_table</span>
    <span class="c1"># Replace zeroes with missing valuese</span>
    <span class="n">table</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">protein_col</span><span class="p">]</span>
    <span class="n">intensity_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">intensity_cols</span><span class="p">]</span>
    <span class="n">replace_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniq_spc_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">replace_str</span> <span class="o">=</span> <span class="s1">&#39;Unique &#39;</span>
    <span class="n">spc_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">spc_cols</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">ic</span><span class="p">:</span> <span class="n">ic</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">replace_str</span><span class="si">}</span><span class="s1">Spectral Count&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                 <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">spc_cols</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">replace_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniq_intensity_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">replace_str</span> <span class="o">=</span> <span class="s1">&#39;Unique &#39;</span>
    <span class="k">if</span> <span class="n">intensity_table</span><span class="p">[</span><span class="n">intensity_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">intensity_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;No data&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;No data&#39;</span><span class="p">]})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">intensity_table</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">ic</span><span class="p">:</span> <span class="n">ic</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">replace_str</span><span class="si">}</span><span class="s1">Intensity&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MaxLFQ&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                     <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">intensity_cols</span><span class="p">},</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">intensity_table</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">intensity_table</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">spc_table</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">spc_table</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">intensity_table</span><span class="p">,</span> <span class="n">spc_table</span><span class="p">,</span> <span class="n">protein_lengths</span><span class="p">)</span></div>



<div class="viewcode-block" id="read_matrix">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.read_matrix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_matrix</span><span class="p">(</span><span class="n">data_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">is_spc_table</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                <span class="n">max_spc_ever</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads a generic matrix into a data table.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        data_table (pd.DataFrame): Input data matrix</span>
<span class="sd">        is_spc_table (bool, optional): Whether matrix contains spectral counts. </span>
<span class="sd">            Defaults to False</span>
<span class="sd">        max_spc_ever (int, optional): Maximum expected spectral count value. </span>
<span class="sd">            Defaults to 0</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: Contains:</span>
<span class="sd">            - pd.DataFrame: Intensity table</span>
<span class="sd">            - pd.DataFrame: Spectral count table</span>
<span class="sd">            - dict: Protein length information if available</span>
<span class="sd">            </span>
<span class="sd">    Notes:</span>
<span class="sd">        - Automatically detects spectral count tables</span>
<span class="sd">        - Handles protein length information</span>
<span class="sd">        - Removes non-numeric columns</span>
<span class="sd">        - Replaces zeros with NaN values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">protein_id_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Protein.Group&#39;</span>
    <span class="n">table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">data_table</span>
    <span class="k">if</span> <span class="n">protein_id_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">protein_id_column</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">protein_lengths</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">protein_length_cols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PROTLEN&#39;</span><span class="p">,</span> <span class="s1">&#39;Protein Length&#39;</span><span class="p">,</span> <span class="s1">&#39;Protein.Length&#39;</span><span class="p">]</span>
    <span class="n">protein_length_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">protein_length_cols</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">plencol</span> <span class="ow">in</span> <span class="n">protein_length_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">plencol</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">protein_lengths</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[[</span><span class="n">protein_id_column</span><span class="p">,</span> <span class="n">plencol</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">protein_lengths</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">protein_id_column</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">plencol</span><span class="p">]</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">plencol</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="n">table</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">protein_id_column</span><span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="s1">&#39;na&#39;</span><span class="p">]</span>
    <span class="n">drop_cols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Remove non-numeric columns and convert numeric-looking columns to numeric</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">isnumber</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isnumber</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">table</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                <span class="k">continue</span>
    <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">max_spc_ever</span><span class="p">:</span>
        <span class="n">is_spc_table</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Replace zeroes with missing values</span>
    <span class="n">table</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">spc_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;No data&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;No data&#39;</span><span class="p">]})</span>
    <span class="n">intensity_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;No data&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;No data&#39;</span><span class="p">]})</span>
    <span class="k">if</span> <span class="n">is_spc_table</span><span class="p">:</span>
        <span class="n">spc_table</span> <span class="o">=</span> <span class="n">table</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">intensity_table</span> <span class="o">=</span> <span class="n">table</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">intensity_table</span><span class="p">,</span> <span class="n">spc_table</span><span class="p">,</span> <span class="n">protein_lengths</span><span class="p">)</span></div>



<div class="viewcode-block" id="read_df_from_content">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.read_df_from_content">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_df_from_content</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lowercase_columns</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a dataframe from uploaded file content.</span>

<span class="sd">    :param content: Base64 encoded file content.</span>
<span class="sd">    :param filename: Original filename with extension.</span>
<span class="sd">    :param lowercase_columns: Whether to convert column names to lowercase.</span>
<span class="sd">    :returns: Parsed DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content_string</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">content_string</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">decoded_content</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">content_string</span><span class="p">)</span>
    <span class="n">f_end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">f_end</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span>
            <span class="n">decoded_content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">f_end</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;tab&#39;</span><span class="p">,</span> <span class="s1">&#39;txt&#39;</span><span class="p">]:</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span>
            <span class="n">decoded_content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">f_end</span> <span class="o">==</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
            <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">decoded_content</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">f_end</span> <span class="o">==</span> <span class="s1">&#39;xls&#39;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
            <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">decoded_content</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;xlrd&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lowercase_columns</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="remove_all_na">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.remove_all_na">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_all_na</span><span class="p">(</span><span class="n">data_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">subset</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">|</span><span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes rows with all missing values from a data table .&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data_table</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_table</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_data_from_content">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.read_data_from_content">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_data_from_content</span><span class="p">(</span><span class="n">file_contents</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">maxpsm</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine and apply the appropriate read function for a data file.</span>

<span class="sd">    :param file_contents: Contents of the uploaded file.</span>
<span class="sd">    :param filename: Name of the uploaded file.</span>
<span class="sd">    :param maxpsm: Maximum theoretical PSM value for spectral counting.</span>
<span class="sd">    :returns: Tuple of (tables dict in JSON split, info dict).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">read_df_from_content</span><span class="p">(</span><span class="n">file_contents</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">text_handling</span><span class="o">.</span><span class="n">replace_accent_and_special_characters</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">allow_space</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">make_lowercase</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="c1"># Validation: initialize containers</span>
    <span class="n">warnings</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">validation</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Pre-parse sanity metrics on initial table</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;rows_initial&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="s1">&#39;cols_initial&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s1">&#39;numeric_cols_initial&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">})</span>
        <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;rows_initial&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Empty file: 0 rows&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;cols_initial&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Suspiciously few columns (&lt;2)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;numeric_cols_initial&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;No numeric columns detected&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Be conservative: do not fail parsing due to validation</span>
        <span class="k">pass</span>

    <span class="n">read_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="s1">&#39;DIA&#39;</span><span class="p">,</span> <span class="s1">&#39;DIA-NN&#39;</span><span class="p">):</span> <span class="n">read_dia_nn</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;DDA&#39;</span><span class="p">,</span> <span class="s1">&#39;FragPipe&#39;</span><span class="p">):</span> <span class="n">read_fragpipe</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;DDA/DIA&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">):</span> <span class="n">read_matrix</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">data_type</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">keyword_args</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;Protein.Ids&#39;</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;First.Protein.Description&#39;</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;DIA&#39;</span><span class="p">,</span> <span class="s1">&#39;DIA-NN&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;Top Peptide Probability&#39;</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;Protein Existence&#39;</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;DDA&#39;</span><span class="p">,</span> <span class="s1">&#39;FragPipe&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;DDA/DIA&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
        <span class="n">keyword_args</span><span class="p">[</span><span class="s1">&#39;max_spc_ever&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxpsm</span>
    <span class="n">intensity_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">spc_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">protein_length_dict</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">intensity_table</span><span class="p">,</span> <span class="n">spc_table</span><span class="p">,</span> <span class="n">protein_length_dict</span> <span class="o">=</span> <span class="n">read_funcs</span><span class="p">[</span><span class="n">data_type</span><span class="p">](</span>
        <span class="n">table</span><span class="p">,</span> <span class="o">**</span><span class="n">keyword_args</span><span class="p">)</span>
    <span class="n">intensity_table</span> <span class="o">=</span> <span class="n">remove_duplicate_protein_groups</span><span class="p">(</span><span class="n">intensity_table</span><span class="p">)</span>
    <span class="n">spc_table</span> <span class="o">=</span> <span class="n">remove_duplicate_protein_groups</span><span class="p">(</span><span class="n">spc_table</span><span class="p">)</span>
    <span class="c1"># Post-reader validation metrics for intensity and spc tables</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;intensity&#39;</span><span class="p">,</span> <span class="n">intensity_table</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;spc&#39;</span><span class="p">,</span> <span class="n">spc_table</span><span class="p">)]:</span>
            <span class="n">is_placeholder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;No data&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">nrows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ncols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">num_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span>
            <span class="n">nnum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">non_nan</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="k">if</span> <span class="n">nnum</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">all_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">nnum</span> <span class="ow">and</span> <span class="p">(</span><span class="n">num_df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">all_nan</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">nnum</span> <span class="ow">and</span> <span class="n">num_df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
            <span class="n">validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_rows&#39;</span><span class="p">:</span> <span class="n">nrows</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_cols&#39;</span><span class="p">:</span> <span class="n">ncols</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_numeric_cols&#39;</span><span class="p">:</span> <span class="n">nnum</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_non_nan_values&#39;</span><span class="p">:</span> <span class="n">non_nan</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">if</span> <span class="n">is_placeholder</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> table missing or placeholder&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nrows</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ncols</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> table very small (rows&lt;=1 or cols&lt;=1)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> has no numeric columns&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">all_nan</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> numeric data all NA&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">all_zero</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> numeric data sums to 0&#39;</span><span class="p">)</span>
        <span class="c1"># Combined checks</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;intensity_rows&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spc_rows&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Both intensity and SPC tables are missing or tiny&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;intensity_numeric_cols&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spc_numeric_cols&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;No numeric data available in intensity nor SPC&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Do not interrupt main flow due to validation</span>
        <span class="k">pass</span>

    <span class="n">info_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;protein lengths&#39;</span><span class="p">:</span> <span class="n">protein_length_dict</span><span class="p">,</span>
        <span class="s1">&#39;Data type&#39;</span><span class="p">:</span> <span class="n">data_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;Data source guess&#39;</span><span class="p">:</span> <span class="n">data_type</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;validation&#39;</span><span class="p">:</span> <span class="n">validation</span><span class="p">,</span>
        <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="n">warnings</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">table_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;spc&#39;</span><span class="p">:</span> <span class="n">spc_table</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">),</span>
        <span class="s1">&#39;int&#39;</span><span class="p">:</span> <span class="n">intensity_table</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">table_dict</span><span class="p">,</span> <span class="n">info_dict</span></div>



<div class="viewcode-block" id="guess_controls">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.guess_controls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">guess_controls</span><span class="p">(</span><span class="n">sample_groups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">ctrl_indicators</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Guesses control samples from sample group names based on indicator terms.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        sample_groups (dict): Dictionary mapping group names to sample lists</span>
<span class="sd">        ctrl_indicators (list): List of strings that indicate control samples</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: Contains:</span>
<span class="sd">            - list: Control group names</span>
<span class="sd">            - list: Lists of samples in each control group</span>
<span class="sd">            </span>
<span class="sd">    Notes:</span>
<span class="sd">        - Case-insensitive matching of control indicators</span>
<span class="sd">        - Returns empty lists if no controls are found</span>
<span class="sd">        - Each control group&#39;s samples are kept together</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">control_groups</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">control_samples</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">samples</span> <span class="ow">in</span> <span class="n">sample_groups</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">might_be_control</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">ctrl_ind</span> <span class="ow">in</span> <span class="n">ctrl_indicators</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ctrl_ind</span> <span class="ow">in</span> <span class="n">group_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">might_be_control</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">might_be_control</span><span class="p">:</span>
            <span class="n">control_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
            <span class="n">control_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">control_groups</span><span class="p">,</span> <span class="n">control_samples</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_comparisons">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.parse_comparisons">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_comparisons</span><span class="p">(</span><span class="n">control_group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">comparison_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span> 
                     <span class="n">sgroups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parses control group and comparison data into pairwise comparisons.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        control_group (str): Name of the main control group</span>
<span class="sd">        comparison_data (list): List of explicit [sample, control] comparisons</span>
<span class="sd">        sgroups (dict): Dictionary of all sample groups</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        list: List of [sample, control] pairs representing comparisons</span>
<span class="sd">            </span>
<span class="sd">    Notes:</span>
<span class="sd">        - If control_group is specified, creates comparisons against all other groups</span>
<span class="sd">        - Appends any explicit comparisons from comparison_data</span>
<span class="sd">        - Skips invalid group names</span>
<span class="sd">        - Returns empty list if no valid comparisons found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">comparisons</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">control_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">control_group</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">comparisons</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">sample</span><span class="p">,</span> <span class="n">control_group</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sgroups</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="k">if</span> <span class="n">sample</span> <span class="o">!=</span> <span class="n">control_group</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">comparison_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparison_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">comparisons</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comparison_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">comparisons</span></div>



<div class="viewcode-block" id="remove_duplicate_protein_groups">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.remove_duplicate_protein_groups">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_duplicate_protein_groups</span><span class="p">(</span><span class="n">data_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove duplicate protein groups by aggregating their values.</span>

<span class="sd">    :param data_table: Input data table with protein groups as index.</span>
<span class="sd">    :returns: Table with unique protein groups and aggregated values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If no columns remain (e.g., non-numeric columns were dropped earlier),</span>
    <span class="c1"># there is nothing to aggregate. Return as-is to avoid pandas concat error.</span>
    <span class="k">if</span> <span class="n">data_table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data_table</span>
    <span class="n">aggfuncs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">numerical_columns</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">data_table</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">numerical_columns</span><span class="p">:</span>
            <span class="n">aggfuncs</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sum&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aggfuncs</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;first&#39;</span>
    <span class="k">return</span> <span class="n">data_table</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">data_table</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">aggfuncs</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_data_file">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.parse_data_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_data_file</span><span class="p">(</span><span class="n">data_file_contents</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                   <span class="n">data_file_modified_data</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">new_upload_style</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> 
                   <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parses a data file and validates its contents.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_file_contents: The contents of the uploaded file</span>
<span class="sd">        data_file_name (str): Name of the uploaded file</span>
<span class="sd">        data_file_modified_data: Last modified timestamp of the file</span>
<span class="sd">        new_upload_style (dict): Style dictionary for UI feedback</span>
<span class="sd">        parameters (dict): Processing parameters including max PSM threshold</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Contains:</span>
<span class="sd">            - dict: Updated upload style with background color indicating status</span>
<span class="sd">            - dict: File info including metadata and data type</span>
<span class="sd">            - dict: Tables dictionary with intensity and spectral count data in split JSON format</span>
<span class="sd">            - list: List of warnings</span>
<span class="sd">    Notes:</span>
<span class="sd">        - Validates file has sufficient numeric columns (&gt;=3)</span>
<span class="sd">        - Sets background-color to &#39;green&#39; if valid, &#39;red&#39; if invalid</span>
<span class="sd">        - Tables are stored in split JSON format for serialization</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Modified time&#39;</span><span class="p">:</span> <span class="n">data_file_modified_data</span><span class="p">,</span>
        <span class="s1">&#39;File name&#39;</span><span class="p">:</span> <span class="n">data_file_name</span>
    <span class="p">}</span>
    <span class="n">tables</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">more_info</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">tables</span><span class="p">,</span> <span class="n">more_info</span> <span class="o">=</span> <span class="n">read_data_from_content</span><span class="p">(</span>
        <span class="n">data_file_contents</span><span class="p">,</span>
        <span class="n">data_file_name</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Maximum psm ever theoretically encountered&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">more_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">has_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>


    <span class="n">warnings</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dt_info</span> <span class="o">=</span> <span class="n">more_info</span><span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dt_info</span><span class="p">[</span><span class="s1">&#39;spc_numeric_cols&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dt_info</span><span class="p">[</span><span class="s1">&#39;intensity_numeric_cols&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- Data table: Neither intensity nor spectral count columns were able to be identified in input.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dt_info</span><span class="p">[</span><span class="s1">&#39;spc_rows&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dt_info</span><span class="p">[</span><span class="s1">&#39;intensity_rows&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- Data table: Neither intensity nor spectral count data was able to be identified in input.&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">table_data</span> <span class="ow">in</span> <span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">table_data</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;No data&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">data_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
                    <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">table_data</span><span class="p">),</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
                <span class="n">numeric_columns</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="n">data_table</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numeric_columns</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">has_data</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">remove_all_na</span><span class="p">(</span><span class="n">data_table</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">numeric_columns</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new_upload_style</span><span class="p">[</span><span class="s1">&#39;background-color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_data</span><span class="p">:</span>
        <span class="n">new_upload_style</span><span class="p">[</span><span class="s1">&#39;background-color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">new_upload_style</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">warnings</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_sample_table_column">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.check_sample_table_column">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_sample_table_column</span><span class="p">(</span><span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">accepted_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if a column name matches any accepted values.</span>

<span class="sd">    Args:</span>
<span class="sd">        column (str): Column name to check</span>
<span class="sd">        accepted_values (list): List of valid column name variations</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Original column name if match found, None otherwise</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Case-insensitive matching</span>
<span class="sd">        - Returns exact original column name if match found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">accepted_values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">candidate</span> <span class="o">==</span> <span class="n">column</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">column</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="check_required_columns">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.check_required_columns">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_required_columns</span><span class="p">(</span><span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates presence of required columns in sample table.</span>

<span class="sd">    Args:</span>
<span class="sd">        columns (list): List of column names to check</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Contains:</span>
<span class="sd">            - dict: Mapping of standardized names to actual column names</span>
<span class="sd">            - set: Set of required column types that were found</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Required columns: sample name, sample group</span>
<span class="sd">        - Optional columns: bait uniprot/id</span>
<span class="sd">        - Case-insensitive matching of column names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reqs_found</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">needed_sample_info_columns</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="p">{(</span><span class="s1">&#39;req&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;sample name&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_name&#39;</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;req&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="s1">&#39;sample group&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_group&#39;</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;bait uniprot&#39;</span><span class="p">,</span> <span class="s1">&#39;bait_uniprot&#39;</span><span class="p">,</span> <span class="s1">&#39;bait_id&#39;</span><span class="p">,</span> <span class="s1">&#39;bait id&#39;</span><span class="p">))}</span>
    <span class="n">infodict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">needed_sample_info_columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">found</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">check_sample_table_column</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">valname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">infodict</span><span class="p">[</span><span class="n">valname</span><span class="p">]</span> <span class="o">=</span> <span class="n">found</span>
                <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;req&#39;</span><span class="p">:</span>
                    <span class="n">reqs_found</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">valname</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">infodict</span><span class="p">,</span> <span class="n">reqs_found</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_sample_table">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.parse_sample_table">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_sample_table</span><span class="p">(</span><span class="n">data_file_contents</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">data_file_modified_data</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                      <span class="n">new_upload_style</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse and validate a sample metadata table.</span>

<span class="sd">    :param data_file_contents: Contents of the uploaded sample table file.</span>
<span class="sd">    :param data_file_name: Name of the uploaded file.</span>
<span class="sd">    :param data_file_modified_data: Last modified timestamp of the file.</span>
<span class="sd">    :param new_upload_style: Style dictionary for UI feedback.</span>
<span class="sd">    :returns: Tuple of (new style, info dict, table JSON split).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Modified time&#39;</span><span class="p">:</span> <span class="n">data_file_modified_data</span><span class="p">,</span>
        <span class="s1">&#39;File name&#39;</span><span class="p">:</span> <span class="n">data_file_name</span>
    <span class="p">}</span>
    <span class="n">decoded_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">read_df_from_content</span><span class="p">(</span>
        <span class="n">data_file_contents</span><span class="p">,</span> <span class="n">data_file_name</span><span class="p">)</span>
    <span class="n">indicator_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">decoded_table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">decoded_table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">indicator_color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
    <span class="n">reqs_found</span><span class="p">:</span> <span class="nb">set</span>
    <span class="n">additional_info</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">additional_info</span><span class="p">,</span> <span class="n">reqs_found</span> <span class="o">=</span> <span class="n">check_required_columns</span><span class="p">(</span><span class="n">decoded_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;required columns found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">reqs_found</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">additional_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reqs_found</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">indicator_color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;bait uniprot&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
        <span class="n">indicator_color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
    <span class="n">new_upload_style</span><span class="p">[</span><span class="s1">&#39;background-color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indicator_color</span>
    <span class="k">if</span> <span class="n">indicator_color</span> <span class="o">!=</span> <span class="s1">&#39;red&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">decoded_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">decoded_table</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">text_handling</span><span class="o">.</span><span class="n">replace_accent_and_special_characters</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">allow_space</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">make_lowercase</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">decoded_table</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">new_upload_style</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">decoded_table</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">))</span></div>



<div class="viewcode-block" id="check_bait">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.check_bait">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_bait</span><span class="p">(</span><span class="n">bait_entry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if a string contains a valid bait name.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        bait_entry (str): The bait entry to validate</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: A string representation of the bait. Returns &#39;No bait uniprot&#39; if the entry is </span>
<span class="sd">            empty, None, or &#39;nan&#39;</span>
<span class="sd">            </span>
<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; check_bait(&#39;P12345&#39;)</span>
<span class="sd">        &#39;P12345&#39;</span>
<span class="sd">        &gt;&gt;&gt; check_bait(None) </span>
<span class="sd">        &#39;No bait uniprot&#39;</span>
<span class="sd">        &gt;&gt;&gt; check_bait(&#39;nan&#39;)</span>
<span class="sd">        &#39;No bait uniprot&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bval</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">bait_entry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bait_entry</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">bval</span> <span class="o">==</span> <span class="s1">&#39;nan&#39;</span><span class="p">):</span>
        <span class="n">bval</span> <span class="o">=</span> <span class="s1">&#39;No bait uniprot&#39;</span>
    <span class="k">return</span> <span class="n">bval</span></div>



<div class="viewcode-block" id="format_data">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.format_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_data</span><span class="p">(</span><span class="n">session_uid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_tables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> 
                <span class="n">data_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">expdes_table</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                <span class="n">expdes_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">contaminants_to_remove</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                <span class="n">replace_replicate_names</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">use_unique_only</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="n">control_indicators</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                <span class="n">bait_id_column_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Formats experimental data into a standardized dictionary structure for analysis.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        session_uid (str): Unique identifier for the analysis session</span>
<span class="sd">        data_tables (dict): Dictionary containing intensity and spectral count tables in JSON format</span>
<span class="sd">        data_info (dict): Metadata about the data tables including file info and data type</span>
<span class="sd">        expdes_table (dict): Experimental design table in JSON format</span>
<span class="sd">        expdes_info (dict): Metadata about the experimental design table</span>
<span class="sd">        contaminants_to_remove (list): List of contaminant proteins to filter out</span>
<span class="sd">        replace_replicate_names (bool): Whether to replace sample names with standardized replicate names</span>
<span class="sd">        use_unique_only (bool): Whether to use only unique peptides/proteins</span>
<span class="sd">        control_indicators (list): List of terms that indicate control samples</span>
<span class="sd">        bait_id_column_names (list): List of possible column names for bait identifiers</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: A structured dictionary containing:</span>
<span class="sd">            - sample_groups: Sample grouping information</span>
<span class="sd">            - data_tables: Processed data tables (intensity, spectral counts, etc.)</span>
<span class="sd">            - info: Processing metadata and experiment type</span>
<span class="sd">            - file_info: Source file information</span>
<span class="sd">            - other: Additional data including protein lengths and bait information</span>
<span class="sd">            </span>
<span class="sd">    Notes:</span>
<span class="sd">        - Intensity values are log2 transformed if present</span>
<span class="sd">        - Zero values are replaced with NaN</span>
<span class="sd">        - Tables are stored in JSON split format</span>
<span class="sd">        - Experiment type is determined based on presence of bait information</span>
<span class="sd">        - Control samples are guessed based on provided indicators</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intensity_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
        <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data_tables</span><span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">]),</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="n">spc_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data_tables</span><span class="p">[</span><span class="s1">&#39;spc&#39;</span><span class="p">]),</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="n">expdesign</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">expdes_table</span><span class="p">),</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>


    <span class="n">sample_groups</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">discarded_columns</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">used_columns</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">sample_groups</span><span class="p">,</span> <span class="n">discarded_columns</span><span class="p">,</span> <span class="n">used_columns</span><span class="p">,</span> <span class="n">expdesign</span> <span class="o">=</span> <span class="n">rename_columns_and_update_expdesign</span><span class="p">(</span>
        <span class="n">expdesign</span><span class="p">,</span>
        <span class="p">[</span><span class="n">intensity_table</span><span class="p">,</span> <span class="n">spc_table</span><span class="p">],</span>
        <span class="n">bait_id_column_names</span><span class="p">,</span>
        <span class="n">replace_names</span> <span class="o">=</span> <span class="n">replace_replicate_names</span>
    <span class="p">)</span>
    <span class="n">spc_table</span> <span class="o">=</span> <span class="n">spc_table</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">spc_table</span><span class="o">.</span><span class="n">columns</span><span class="p">))]</span>
    <span class="k">if</span> <span class="n">use_unique_only</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="p">[</span><span class="n">spc_table</span><span class="p">,</span> <span class="n">intensity_table</span><span class="p">]:</span>
            <span class="n">drop_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="s1">&#39;;&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_ind</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">drop_ind</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">discarded_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="p">[</span><span class="n">spc_table</span><span class="p">,</span> <span class="n">intensity_table</span><span class="p">]:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">discarded_columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intensity_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">intensity_table</span> <span class="o">=</span> <span class="n">intensity_table</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">intensity_table</span><span class="o">.</span><span class="n">columns</span><span class="p">))]</span>
        <span class="n">untransformed_intensity_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">intensity_table</span>
        <span class="n">intensity_table</span> <span class="o">=</span> <span class="n">intensity_table</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">untransformed_intensity_table</span> <span class="o">=</span> <span class="n">intensity_table</span>

    <span class="n">wcont_spc_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">spc_table</span>
    <span class="n">wcont_untransformed_intensity_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">untransformed_intensity_table</span>
    <span class="n">wcont_intensity_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">intensity_table</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contaminants_to_remove</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">spc_table</span> <span class="o">=</span> <span class="n">spc_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spc_table</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">contaminants_to_remove</span><span class="p">]]</span>
        <span class="n">untransformed_intensity_table</span> <span class="o">=</span> <span class="n">untransformed_intensity_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">untransformed_intensity_table</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">contaminants_to_remove</span><span class="p">]]</span>
        <span class="n">intensity_table</span> <span class="o">=</span> <span class="n">intensity_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">intensity_table</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">contaminants_to_remove</span><span class="p">]]</span>
    <span class="n">spc_table</span> <span class="o">=</span> <span class="n">spc_table</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">intensity_table</span> <span class="o">=</span> <span class="n">intensity_table</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">experiment_type</span> <span class="o">=</span> <span class="s1">&#39;Proteomics&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;bait uniprot&#39;</span> <span class="ow">in</span> <span class="n">expdes_info</span><span class="p">:</span>
        <span class="n">experiment_type</span> <span class="o">=</span> <span class="s1">&#39;Interactomics&#39;</span>
    <span class="n">return_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;sample groups&#39;</span><span class="p">:</span> <span class="n">sample_groups</span><span class="p">,</span>
        <span class="s1">&#39;data tables&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;raw intensity&#39;</span><span class="p">:</span> <span class="n">untransformed_intensity_table</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">),</span>
            <span class="s1">&#39;spc&#39;</span><span class="p">:</span> <span class="n">spc_table</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">),</span>
            <span class="s1">&#39;intensity&#39;</span><span class="p">:</span> <span class="n">intensity_table</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">),</span>
            <span class="s1">&#39;experimental design&#39;</span><span class="p">:</span> <span class="n">expdesign</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">),</span>
            <span class="s1">&#39;with-contaminants&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;raw intensity&#39;</span><span class="p">:</span> <span class="n">wcont_untransformed_intensity_table</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">),</span>
                <span class="s1">&#39;spc&#39;</span><span class="p">:</span> <span class="n">wcont_spc_table</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">),</span>
                <span class="s1">&#39;intensity&#39;</span><span class="p">:</span> <span class="n">wcont_intensity_table</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;discarded columns&#39;</span><span class="p">:</span> <span class="n">discarded_columns</span><span class="p">,</span>
            <span class="s1">&#39;used columns&#39;</span><span class="p">:</span> <span class="n">used_columns</span><span class="p">,</span>
            <span class="s1">&#39;data type&#39;</span><span class="p">:</span> <span class="n">data_info</span><span class="p">[</span><span class="s1">&#39;Data type&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Expdes based experiment type&#39;</span><span class="p">:</span> <span class="n">experiment_type</span>
        <span class="p">},</span>
        <span class="s1">&#39;file info&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;Data&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;File modified&#39;</span><span class="p">:</span> <span class="n">data_info</span><span class="p">[</span><span class="s1">&#39;Modified time&#39;</span><span class="p">],</span>
                <span class="s1">&#39;File name&#39;</span><span class="p">:</span> <span class="n">data_info</span><span class="p">[</span><span class="s1">&#39;File name&#39;</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;Sample table&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;File modified&#39;</span><span class="p">:</span> <span class="n">expdes_info</span><span class="p">[</span><span class="s1">&#39;Modified time&#39;</span><span class="p">],</span>
                <span class="s1">&#39;File name&#39;</span><span class="p">:</span> <span class="n">expdes_info</span><span class="p">[</span><span class="s1">&#39;File name&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;other&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;session name&#39;</span><span class="p">:</span> <span class="n">session_uid</span><span class="p">,</span>
            <span class="s1">&#39;protein lengths&#39;</span><span class="p">:</span> <span class="n">data_info</span><span class="p">[</span><span class="s1">&#39;protein lengths&#39;</span><span class="p">],</span>
            <span class="s1">&#39;experimental design all info&#39;</span><span class="p">:</span> <span class="n">expdes_info</span><span class="p">,</span>
            <span class="s1">&#39;data table all info&#39;</span><span class="p">:</span> <span class="n">data_info</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">return_dict</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">][</span><span class="s1">&#39;bait uniprots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;Bait uniprot&#39;</span> <span class="ow">in</span> <span class="n">expdesign</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">expdesign</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">return_dict</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">][</span><span class="s1">&#39;bait uniprots&#39;</span><span class="p">][</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Sample group&#39;</span><span class="p">]</span>
                                                  <span class="p">]</span> <span class="o">=</span> <span class="n">check_bait</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Bait uniprot&#39;</span><span class="p">])</span>
        <span class="n">return_dict</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">][</span><span class="s1">&#39;Expdes based experiment type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Interactomics&#39;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intensity_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">return_dict</span><span class="p">[</span><span class="s1">&#39;data tables&#39;</span><span class="p">][</span><span class="s1">&#39;table to use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;spc&#39;</span>
        <span class="n">return_dict</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">][</span><span class="s1">&#39;all proteins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spc_table</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">return_dict</span><span class="p">[</span><span class="s1">&#39;data tables&#39;</span><span class="p">][</span><span class="s1">&#39;table to use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;intensity&#39;</span>
        <span class="n">return_dict</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">][</span><span class="s1">&#39;all proteins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">intensity_table</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="n">return_dict</span><span class="p">[</span><span class="s1">&#39;sample groups&#39;</span><span class="p">][</span><span class="s1">&#39;guessed control samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess_controls</span><span class="p">(</span>
        <span class="n">sample_groups</span><span class="p">,</span> <span class="n">control_indicators</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">return_dict</span></div>



<div class="viewcode-block" id="remove_from_table">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.remove_from_table">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_from_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                     <span class="n">discard_samples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes specified samples from a data table based on table type.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name (str): Name of the table being processed</span>
<span class="sd">        table (pd.DataFrame): Data table to remove samples from</span>
<span class="sd">        discard_samples (list): List of sample names to remove</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Table with specified samples removed</span>

<span class="sd">    Notes:</span>
<span class="sd">        - For experimental design tables, removes rows where Sample name matches discard list</span>
<span class="sd">        - For other tables, removes columns matching discard list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s1">&#39;experimental design&#39;</span><span class="p">:</span>
        <span class="n">table_without_discarded_samples</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span>
            <span class="o">~</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Sample name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">discard_samples</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">table_without_discarded_samples</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span>
            <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">discard_samples</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="n">table_without_discarded_samples</span></div>



<div class="viewcode-block" id="delete_samples">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.delete_samples">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_samples</span><span class="p">(</span><span class="n">discard_samples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                  <span class="n">data_dictionary</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes specified samples from all tables in the data dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        discard_samples (list): List of sample names to remove</span>
<span class="sd">        data_dictionary (dict): Dictionary containing all experimental data tables and metadata</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Updated data dictionary with samples removed and sample groups adjusted</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Processes all tables including intensity, spectral counts, and experimental design</span>
<span class="sd">        - Updates sample group mappings to reflect removed samples</span>
<span class="sd">        - Adds list of discarded samples to dictionary</span>
<span class="sd">        - Handles both regular and contaminant-containing tables</span>
<span class="sd">        - Removes empty sample groups after sample deletion</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table_json</span> <span class="ow">in</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;data tables&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s1">&#39;table to use&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s1">&#39;with-contaminants&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">real_table_name</span><span class="p">,</span> <span class="n">table_json</span> <span class="ow">in</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;data tables&#39;</span><span class="p">][</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">table_without_discarded_samples</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">remove_from_table</span><span class="p">(</span>
                    <span class="n">real_table_name</span><span class="p">,</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">table_json</span><span class="p">),</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">),</span>
                    <span class="n">discard_samples</span>
                <span class="p">)</span>
                <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;data tables&#39;</span><span class="p">][</span><span class="s1">&#39;with-contaminants&#39;</span><span class="p">][</span><span class="n">real_table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_without_discarded_samples</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span>
                    <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">table_without_discarded_samples</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">remove_from_table</span><span class="p">(</span>
                <span class="n">table_name</span><span class="p">,</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">table_json</span><span class="p">),</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">),</span>
                <span class="n">discard_samples</span>
            <span class="p">)</span>
            <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;data tables&#39;</span><span class="p">][</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_without_discarded_samples</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span>
                <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span>
            <span class="p">)</span>
    <span class="n">sg_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;rev&#39;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="k">for</span> <span class="n">sample_group_name</span><span class="p">,</span> <span class="n">sample_group_samples</span> <span class="ow">in</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;sample groups&#39;</span><span class="p">][</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">group_samples</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">s_name</span> <span class="k">for</span> <span class="n">s_name</span> <span class="ow">in</span> <span class="n">sample_group_samples</span> <span class="k">if</span> <span class="n">s_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">discard_samples</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_samples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">sg_dict</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="n">sample_group_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_samples</span>
    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">samples</span> <span class="ow">in</span> <span class="n">sg_dict</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="n">sg_dict</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">][</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
    <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;sample groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sg_dict</span>
    <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;user-discarded samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">discard_samples</span>

    <span class="k">return</span> <span class="n">data_dictionary</span></div>


<div class="viewcode-block" id="clean_sample_names">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.clean_sample_names">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_sample_names</span><span class="p">(</span><span class="n">expdesign</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                      <span class="n">bait_id_column_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean and validate the experimental design dataframe.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        expdesign (pd.DataFrame): Input experimental design dataframe containing at minimum</span>
<span class="sd">            &#39;Sample group&#39; and &#39;Sample name&#39; columns</span>
<span class="sd">        bait_id_column_names (list): List of possible column names that could contain</span>
<span class="sd">            bait identifiers (e.g., [&#39;bait id&#39;, &#39;bait uniprot&#39;])</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Cleaned experimental design dataframe with:</span>
<span class="sd">            - Rows containing missing required values removed</span>
<span class="sd">            - All values converted to strings</span>
<span class="sd">            - Sample names cleaned of file paths and special characters</span>
<span class="sd">            - Standardized bait column name if present</span>
<span class="sd">            </span>
<span class="sd">    Notes:</span>
<span class="sd">        - Required columns are &#39;Sample group&#39; and &#39;Sample name&#39;</span>
<span class="sd">        - Rows with NA values in required columns are dropped</span>
<span class="sd">        - File paths in sample names are removed (handles both Windows and Unix paths)</span>
<span class="sd">        - Special characters in sample names are replaced with underscores</span>
<span class="sd">        - If a bait identifier column exists, it is renamed to &#39;Bait uniprot&#39;</span>
<span class="sd">        - All modifications are done on a copy of the input dataframe</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; expd = pd.DataFrame({</span>
<span class="sd">        ...     &#39;Sample name&#39;: [&#39;path/to/sample1.raw&#39;, &#39;sample2&#39;],</span>
<span class="sd">        ...     &#39;Sample group&#39;: [&#39;group1&#39;, &#39;group2&#39;],</span>
<span class="sd">        ...     &#39;bait id&#39;: [&#39;P12345&#39;, &#39;P67890&#39;]</span>
<span class="sd">        ... })</span>
<span class="sd">        &gt;&gt;&gt; cleaned = clean_sample_names(expd, [&#39;bait id&#39;, &#39;bait uniprot&#39;])</span>
<span class="sd">        &gt;&gt;&gt; cleaned[&#39;Sample name&#39;]</span>
<span class="sd">        0    sample1</span>
<span class="sd">        1    sample2</span>
<span class="sd">        Name: Sample name, dtype: object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Remove rows with missing required values</span>
    <span class="n">expd_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Sample name&#39;</span><span class="p">,</span><span class="s1">&#39;Sample group&#39;</span><span class="p">]</span>
    <span class="n">init_rename</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">expd_columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">expdesign</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="n">init_rename</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">expdesign</span> <span class="o">=</span> <span class="n">expdesign</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">init_rename</span><span class="p">)</span>

    <span class="n">expdesign</span> <span class="o">=</span> <span class="n">expdesign</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">expdesign</span><span class="p">[</span><span class="n">expd_columns</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">expd_columns</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">expdesign</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expd_columns</span><span class="p">])</span>
    <span class="c1"># Convert all values to strings</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">expd_columns</span><span class="p">:</span>
        <span class="n">expdesign</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">expdesign</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_to_str</span><span class="p">)</span>
    <span class="c1"># Remove file paths from sample names (handles both Windows and Unix paths)</span>
    <span class="n">expdesign</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;Sample name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expdesign</span><span class="p">[</span><span class="s1">&#39;Sample name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">text_handling</span><span class="o">.</span><span class="n">replace_special_characters</span><span class="p">(</span>
            <span class="n">clean_column_name</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
            <span class="n">replacewith</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">make_lowercase</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">expdesign</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;Sample group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expdesign</span><span class="p">[</span><span class="s1">&#39;Sample group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">text_handling</span><span class="o">.</span><span class="n">replace_special_characters</span><span class="p">(</span>
            <span class="n">clean_column_name</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
            <span class="n">replacewith</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">make_lowercase</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Standardize bait column name if it exists</span>
    <span class="k">for</span> <span class="n">bid</span> <span class="ow">in</span> <span class="n">bait_id_column_names</span><span class="p">:</span>
        <span class="n">matching_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">expdesign</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">bid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">matching_cols</span><span class="p">:</span>
            <span class="n">expdesign</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">matching_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="s1">&#39;Bait uniprot&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">expdesign</span></div>


<div class="viewcode-block" id="clean_column_name">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.clean_column_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_column_name</span><span class="p">(</span><span class="n">col_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes file paths and extensions from column names.</span>

<span class="sd">    Args:</span>
<span class="sd">        col_name (str): Original column name potentially containing path and extensions</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Cleaned column name with paths and extensions removed</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Handles both Windows and Unix style paths</span>
<span class="sd">        - Removes _SPC suffix</span>
<span class="sd">        - Removes .d extension</span>
<span class="sd">        - Processes path components from right to left</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">col_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_SPC&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.d&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">col</span></div>


<div class="viewcode-block" id="format_sample_group_name">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.format_sample_group_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_sample_group_name</span><span class="p">(</span><span class="n">sample_group</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format sample group names, handling numeric cases.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        sample_group: The sample group identifier to format. Can be numeric or string.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Formatted sample group name. Returns None if input is NaN.</span>
<span class="sd">            For numeric inputs, returns &quot;SampleGroup_&lt;number&gt;&quot;.</span>
<span class="sd">            For string inputs, returns the string value.</span>
<span class="sd">            </span>
<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; format_sample_group_name(1)</span>
<span class="sd">        &#39;SampleGroup_1&#39;</span>
<span class="sd">        &gt;&gt;&gt; format_sample_group_name(&quot;Control&quot;)</span>
<span class="sd">        &#39;Control&#39;</span>
<span class="sd">        &gt;&gt;&gt; format_sample_group_name(np.nan)</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">sample_group</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">try_num</span> <span class="o">=</span> <span class="n">check_numeric</span><span class="p">(</span><span class="n">sample_group</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">try_num</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;SampleGroup_</span><span class="si">{</span><span class="n">try_num</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample_group</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_replicate_name">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.generate_replicate_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_replicate_name</span><span class="p">(</span><span class="n">group_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sample_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                          <span class="n">existing_names</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">replace_names</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate unique replicate names for samples within groups.</span>
<span class="sd">    </span>
<span class="sd">    :param group_name: Name of the sample group.</span>
<span class="sd">    :type group_name: str</span>
<span class="sd">    :param sample_name: Original name of the sample.</span>
<span class="sd">    :type sample_name: str</span>
<span class="sd">    :param existing_names: Set of already assigned replicate names.</span>
<span class="sd">    :type existing_names: Set[str]</span>
<span class="sd">    :param replace_names: If True, generates names like &quot;Group_Rep_1&quot;. </span>
<span class="sd">        If False, preserves original sample names with numeric suffixes if needed.</span>
<span class="sd">    :type replace_names: bool</span>
<span class="sd">        </span>
<span class="sd">    :returns: A unique replicate name that doesn&#39;t exist in existing_names.</span>
<span class="sd">    :rtype: str</span>
<span class="sd">        </span>
<span class="sd">    .. note::</span>
<span class="sd">        When replace_names is True:</span>
<span class="sd">            - Names follow pattern: &quot;{group_name}_Rep_{i}&quot;</span>
<span class="sd">            - i increments until a unique name is found</span>
<span class="sd">            </span>
<span class="sd">        When replace_names is False:</span>
<span class="sd">            - Uses cleaned original sample name as base</span>
<span class="sd">            - Adds &quot;_i&quot; suffix only if needed for uniqueness</span>
<span class="sd">            - i starts at 0 and increments until unique</span>
<span class="sd">            </span>
<span class="sd">    .. rubric:: Examples</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; generate_replicate_name(&quot;Control&quot;, &quot;sample1&quot;, {&quot;Control_Rep_1&quot;}, True)</span>
<span class="sd">    &#39;Control_Rep_2&#39;</span>
<span class="sd">    &gt;&gt;&gt; generate_replicate_name(&quot;Control&quot;, &quot;sample1&quot;, {&quot;sample1&quot;}, False)</span>
<span class="sd">    &#39;sample1_0&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">replace_names</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">_Rep_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">existing_names</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">_Rep_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">clean_column_name</span><span class="p">(</span><span class="n">sample_name</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">existing_names</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">basename</span></div>

    
<div class="viewcode-block" id="rename_columns_and_update_expdesign">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.rename_columns_and_update_expdesign">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rename_columns_and_update_expdesign</span><span class="p">(</span><span class="n">expdesign</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                      <span class="n">tables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
                                      <span class="n">bait_id_column_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                      <span class="n">replace_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span> 
                                                                        <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                                                                        <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> 
                                                                        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standardize sample names and update experimental design.</span>

<span class="sd">    :param expdesign: Experimental design DataFrame with &#39;Sample group&#39; and &#39;Sample name&#39;.</span>
<span class="sd">    :param tables: DataFrames to rename columns in.</span>
<span class="sd">    :param bait_id_column_names: Possible column names containing bait identifiers.</span>
<span class="sd">    :param replace_names: Whether to generate standardized replicate names.</span>
<span class="sd">    :returns: Tuple of (sample groups mapping, discarded columns, used columns, updated expdesign).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initial cleanup</span>
    <span class="n">expdesign</span> <span class="o">=</span> <span class="n">clean_sample_names</span><span class="p">(</span><span class="n">expdesign</span><span class="p">,</span> <span class="n">bait_id_column_names</span><span class="p">)</span>
    <span class="n">discarded_columns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sample_group_columns</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">column_mappings</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of dicts for each table&#39;s column mappings</span>
    
    <span class="c1"># First pass: Map original columns to cleaned names and group assignments</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">column_mappings</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
            <span class="k">continue</span>
            
        <span class="n">table_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">clean_col</span> <span class="o">=</span> <span class="n">col</span>
            <span class="c1"># Attempt cleaning up the column name if not found as is.</span>
            <span class="k">if</span> <span class="n">clean_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expdesign</span><span class="p">[</span><span class="s1">&#39;Sample name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">clean_col</span> <span class="o">=</span> <span class="n">clean_column_name</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">clean_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expdesign</span><span class="p">[</span><span class="s1">&#39;Sample name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">clean_col</span> <span class="o">=</span> <span class="n">text_handling</span><span class="o">.</span><span class="n">replace_special_characters</span><span class="p">(</span><span class="n">clean_col</span><span class="p">,</span><span class="n">replacewith</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">make_lowercase</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Skip if column not in experimental design</span>
            <span class="k">if</span> <span class="n">clean_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expdesign</span><span class="p">[</span><span class="s1">&#39;Sample name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">discarded_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_col</span><span class="p">)</span>
                <span class="n">discarded_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">continue</span>
                
            <span class="c1"># Get and format sample group</span>
            <span class="n">sample_group</span> <span class="o">=</span> <span class="n">expdesign</span><span class="p">[</span><span class="n">expdesign</span><span class="p">[</span><span class="s1">&#39;Sample name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">clean_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Sample group&#39;</span><span class="p">]</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">format_sample_group_name</span><span class="p">(</span><span class="n">sample_group</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">group_name</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="c1"># Initialize group if needed</span>
            <span class="k">if</span> <span class="n">group_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample_group_columns</span><span class="p">:</span>
                <span class="n">sample_group_columns</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">]</span>
            
            <span class="n">table_mapping</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clean_name&#39;</span><span class="p">:</span> <span class="n">clean_col</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">}</span>
            
        <span class="n">column_mappings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_mapping</span><span class="p">)</span>
    <span class="c1"># Second pass: Generate final column names and build sample groups</span>
    <span class="n">sample_groups</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;rev&#39;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="n">used_columns</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">table_idx</span><span class="p">,</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">column_mappings</span><span class="p">):</span>
        <span class="n">final_names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">orig_col</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">generate_replicate_name</span><span class="p">(</span>
                <span class="n">group</span><span class="p">,</span> 
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;clean_name&#39;</span><span class="p">],</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">final_names</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> 
                <span class="n">replace_names</span>
            <span class="p">)</span>
            
            <span class="n">final_names</span><span class="p">[</span><span class="n">orig_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_name</span>
            
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample_groups</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]:</span>
                <span class="n">sample_groups</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sample_groups</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
            <span class="n">sample_groups</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">][</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
            
            <span class="n">used_columns</span><span class="p">[</span><span class="n">table_idx</span><span class="p">][</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_col</span>
            
        <span class="c1"># Apply renames to table</span>
        <span class="n">tables</span><span class="p">[</span><span class="n">table_idx</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">final_names</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Get rid of duplicates introduced due to multiple tables being processed in previous step</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">sample_groups</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]:</span>
        <span class="n">sample_groups</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">sample_groups</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="n">group</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="c1"># Final cleanup: Remove unused samples from expdesign</span>
    <span class="n">used_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">expdesign</span> <span class="o">=</span> <span class="n">expdesign</span><span class="p">[</span><span class="n">expdesign</span><span class="p">[</span><span class="s1">&#39;Sample name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">used_cols</span><span class="p">)]</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">sample_groups</span><span class="p">,</span> <span class="n">discarded_columns</span><span class="p">,</span> <span class="n">used_columns</span><span class="p">,</span> <span class="n">expdesign</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_comparison_file">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.check_comparison_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_comparison_file</span><span class="p">(</span><span class="n">file_contents</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">sgroups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                         <span class="n">new_upload_style</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate and parse a comparison file with sample-control pairs.</span>

<span class="sd">    :param file_contents: Base64 encoded contents of the uploaded comparison file.</span>
<span class="sd">    :param file_name: Name of the uploaded file.</span>
<span class="sd">    :param sgroups: Dictionary of valid sample groups.</span>
<span class="sd">    :param new_upload_style: Style dict updated with status color.</span>
<span class="sd">    :returns: Tuple of (updated style dict, list of valid [sample, control] pairs).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">indicator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">comparisons</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">read_df_from_content</span><span class="p">(</span>
            <span class="n">file_contents</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">lowercase_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">scol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;sample&#39;</span>
        <span class="n">ccol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;control&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;sample&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;control&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">scol</span><span class="p">,</span> <span class="n">ccol</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">scol</span><span class="p">,</span><span class="n">ccol</span><span class="p">]:</span>
            <span class="n">dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">text_handling</span><span class="o">.</span><span class="n">replace_accent_and_special_characters</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">allow_space</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">make_lowercase</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">samplename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">scol</span><span class="p">]</span>
            <span class="n">controlname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">ccol</span><span class="p">]</span>
            <span class="n">try_num</span> <span class="o">=</span> <span class="n">check_numeric</span><span class="p">(</span><span class="n">samplename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">try_num</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
                <span class="n">samplename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SampleGroup_</span><span class="si">{</span><span class="n">try_num</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                
            <span class="n">try_num</span> <span class="o">=</span> <span class="n">check_numeric</span><span class="p">(</span><span class="n">controlname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">try_num</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
                <span class="n">controlname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SampleGroup_</span><span class="si">{</span><span class="n">try_num</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">controlname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">controlname</span><span class="p">)</span>
            <span class="c1"># parse sample and control names based on the same rules as in parsing of the group names. Here we can do a lazier version and just try the SampleGroup_ format, if the group is not found to begin with.</span>
            <span class="k">if</span> <span class="n">samplename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sgroups</span><span class="p">:</span>
                <span class="n">samplename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SampleGroup_</span><span class="si">{</span><span class="n">samplename</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">samplename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sgroups</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">controlname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sgroups</span><span class="p">:</span>
                <span class="n">controlname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SampleGroup_</span><span class="si">{</span><span class="n">controlname</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">controlname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sgroups</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">comparisons</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">samplename</span><span class="p">,</span> <span class="n">controlname</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparisons</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indicator</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparisons</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">indicator</span> <span class="o">=</span> <span class="s1">&#39;yellow&#39;</span>
    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># If content is None, we get an attribute error.</span>
        <span class="n">indicator</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span>
    <span class="n">new_upload_style</span><span class="p">[</span><span class="s1">&#39;background-color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indicator</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">new_upload_style</span><span class="p">,</span> <span class="n">comparisons</span><span class="p">)</span></div>



<div class="viewcode-block" id="validate_basic_inputs">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.parsing.validate_basic_inputs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_basic_inputs</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">fail_on_None</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate basic inputs for ProteoGyver analysis.</span>

<span class="sd">    :param args: Arbitrary inputs; last two are style dicts with &#39;background-color&#39;.</span>
<span class="sd">    :param fail_on_None: If ``True``, treat any ``None`` as invalid.</span>
<span class="sd">    :returns: ``True`` if validation fails, ``False`` otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">not_valid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">fail_on_None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">not_valid</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">style_arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">style_arg</span><span class="p">[</span><span class="s1">&#39;background-color&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span><span class="p">:</span>
            <span class="n">not_valid</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">not_valid</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Kari Salokas.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>