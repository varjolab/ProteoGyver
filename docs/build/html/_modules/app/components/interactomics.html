

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>app.components.interactomics &mdash; ProteoGyver Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=aaadad1f"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ProteoGyver
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Proteogyver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Proteomics_example.html">Example Proteomics usecase for ProteoGyver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Interactomics_example.html">Example Interactomcis usecase for ProteoGyver using a public dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide.html">ProteoGyver User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code/modules.html">Code Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ProteoGyver</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">app.components.interactomics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for app.components.interactomics</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Functions for processing and visualizing protein-protein interaction data.</span>

<span class="sd">This module provides functionality for analyzing mass spectrometry-based</span>
<span class="sd">interactomics data, including:</span>
<span class="sd">- Running and processing SAINT analysis for scoring protein interactions</span>
<span class="sd">- Filtering results based on BFDR and CRAPome metrics</span>
<span class="sd">- Creating visualizations (networks, heatmaps, PCA plots)</span>
<span class="sd">- Performing enrichment analysis</span>
<span class="sd">- MS-microscopy analysis for protein localization</span>
<span class="sd">- Processing known interaction data</span>

<span class="sd">The module integrates with a SQLite database for retrieving reference data</span>
<span class="sd">and uses Dash components for creating interactive visualizations.</span>

<span class="sd">Typical usage example:</span>
<span class="sd">    &gt;&gt;&gt; saint_dict = make_saint_dict(spc_table, sample_groups, controls, proteins)</span>
<span class="sd">    &gt;&gt;&gt; saint_output = run_saint(saint_dict, temp_dir, session_id, bait_ids)</span>
<span class="sd">    &gt;&gt;&gt; filtered_output = saint_filtering(saint_output, bfdr=0.01, crapome_pct=0.1)</span>
<span class="sd">    &gt;&gt;&gt; network_plot = do_network(filtered_output, plot_height=600)</span>

<span class="sd">Attributes:</span>
<span class="sd">    logger: Logger instance for module-level logging</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dash</span><span class="w"> </span><span class="kn">import</span> <span class="n">html</span><span class="p">,</span> <span class="n">dash_table</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">components</span><span class="w"> </span><span class="kn">import</span> <span class="n">db_functions</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sh</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">components.figures</span><span class="w"> </span><span class="kn">import</span> <span class="n">histogram</span><span class="p">,</span> <span class="n">bar_graph</span><span class="p">,</span> <span class="n">scatter</span><span class="p">,</span> <span class="n">heatmaps</span><span class="p">,</span> <span class="n">network_plot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">components</span><span class="w"> </span><span class="kn">import</span> <span class="n">matrix_functions</span><span class="p">,</span> <span class="n">db_functions</span><span class="p">,</span> <span class="n">ms_microscopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">components.figures.figure_legends</span><span class="w"> </span><span class="kn">import</span> <span class="n">INTERACTOMICS_LEGENDS</span> <span class="k">as</span> <span class="n">legends</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">components.figures.figure_legends</span><span class="w"> </span><span class="kn">import</span> <span class="n">enrichment_legend</span><span class="p">,</span> <span class="n">leg_rep</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">components.text_handling</span><span class="w"> </span><span class="kn">import</span> <span class="n">replace_accent_and_special_characters</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">components</span><span class="w"> </span><span class="kn">import</span> <span class="n">EnrichmentAdmin</span> <span class="k">as</span> <span class="n">ea</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dash_bootstrap_components</span><span class="w"> </span><span class="kn">import</span> <span class="n">Card</span><span class="p">,</span> <span class="n">CardBody</span><span class="p">,</span> <span class="n">Tab</span><span class="p">,</span> <span class="n">Tabs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="count_knowns">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.count_knowns">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">count_knowns</span><span class="p">(</span><span class="n">saint_output</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                <span class="n">replicate_colors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Count known interactions per bait protein.</span>

<span class="sd">    :param saint_output: SAINT output with columns including ``Bait`` and ``Known interaction``.</span>
<span class="sd">    :param replicate_colors: Mapping with structure ``{&#39;contaminant&#39;: {&#39;sample groups&#39;: {bait: color}}, &#39;non-contaminant&#39;: {...}}``.</span>
<span class="sd">    :returns: DataFrame with columns ``Bait``, ``Known interaction``, ``Prey count``, and ``Color``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">saint_output</span><span class="p">[[</span><span class="s1">&#39;Bait&#39;</span><span class="p">,</span> <span class="s1">&#39;Known interaction&#39;</span><span class="p">]]</span><span class="o">.</span>\
        <span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="s1">&#39;Prey count&#39;</span><span class="p">})</span>
    <span class="n">color_col</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Known interaction&#39;</span><span class="p">]:</span>
            <span class="n">color_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">replicate_colors</span><span class="p">[</span><span class="s1">&#39;contaminant&#39;</span><span class="p">][</span><span class="s1">&#39;sample groups&#39;</span><span class="p">][</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">replicate_colors</span><span class="p">[</span><span class="s1">&#39;non-contaminant&#39;</span><span class="p">][</span><span class="s1">&#39;sample groups&#39;</span><span class="p">][</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">]])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_col</span>
    <span class="k">return</span> <span class="n">data</span></div>



<div class="viewcode-block" id="do_network">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.do_network">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">do_network</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
              <span class="n">plot_height</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a Cytoscape network from filtered SAINT output.</span>

<span class="sd">    :param saint_output_json: SAINT output in pandas split-JSON format.</span>
<span class="sd">    :param plot_height: Height of the network plot in pixels.</span>
<span class="sd">    :returns: Tuple of (plot container Div, cytoscape elements, interactions dict).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">saint_output</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
        <span class="n">StringIO</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">),</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="n">cyto_elements</span><span class="p">,</span> <span class="n">interactions</span> <span class="o">=</span> <span class="n">network_plot</span><span class="o">.</span><span class="n">get_cytoscape_elements_and_ints</span><span class="p">(</span><span class="n">saint_output</span><span class="p">)</span>
    <span class="n">plot_container</span> <span class="o">=</span> <span class="n">network_plot</span><span class="o">.</span><span class="n">get_cytoscape_container</span><span class="p">(</span><span class="n">cyto_elements</span><span class="p">,</span> <span class="n">full_height</span><span class="o">=</span><span class="n">plot_height</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">plot_container</span><span class="p">,</span> <span class="n">cyto_elements</span><span class="p">,</span> <span class="n">interactions</span><span class="p">)</span></div>



<div class="viewcode-block" id="network_display_data">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.network_display_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">network_display_data</span><span class="p">(</span>
    <span class="n">node_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]],</span> 
    <span class="n">int_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="o">|</span><span class="nb">float</span><span class="p">]]],</span> 
    <span class="n">table_height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
    <span class="n">datatype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Cytoscape&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">Label</span> <span class="o">|</span> <span class="n">dash_table</span><span class="o">.</span><span class="n">DataTable</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a table for network connections.</span>

<span class="sd">    :param node_data: Node data; for Cytoscape use ``{&#39;edgesData&#39;: [{&#39;source&#39;,&#39;target&#39;},...]}``; for visdcc use ``{&#39;edges&#39;: [&#39;source_-_target&#39;, ...]}``.</span>
<span class="sd">    :param int_data: Mapping ``source -&gt; target -&gt; [gene_name, avg_spec]``.</span>
<span class="sd">    :param table_height: Table height in pixels.</span>
<span class="sd">    :param datatype: ``&#39;Cytoscape&#39;`` or ``&#39;visdcc&#39;``.</span>
<span class="sd">    :returns: List containing a label and a DataTable with Bait, Prey, PreyGene, AvgSpec.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;Bait&#39;</span><span class="p">,</span><span class="s1">&#39;Prey&#39;</span><span class="p">,</span> <span class="s1">&#39;PreyGene&#39;</span><span class="p">,</span><span class="s1">&#39;AvgSpec&#39;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;Cytoscape&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">node_data</span><span class="p">[</span><span class="s1">&#39;edgesData&#39;</span><span class="p">]:</span> 
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]])</span>
            <span class="n">ret</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">int_data</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]][</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]])</span>
    <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;visdcc&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">node_data</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]:</span>
            <span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_-_&#39;</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="n">source</span><span class="p">,</span>
                <span class="n">target</span><span class="p">,</span>
                <span class="n">int_data</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="n">target</span><span class="p">]</span>
            <span class="p">])</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">div_contents</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">html</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;Selected node connections:&#39;</span><span class="p">),</span>
        <span class="n">dash_table</span><span class="o">.</span><span class="n">DataTable</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">),</span> 
            <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span>
            <span class="n">fixed_rows</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="n">style_table</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">table_height</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">div_contents</span></div>


<div class="viewcode-block" id="known_plot">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.known_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">known_plot</span><span class="p">(</span><span class="n">filtered_saint_input_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
              <span class="n">db_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
              <span class="n">rep_colors_with_cont</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> 
              <span class="n">figure_defaults</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
              <span class="n">isoform_agnostic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot known interactions per bait.</span>

<span class="sd">    :param filtered_saint_input_json: Filtered SAINT output in pandas split-JSON format.</span>
<span class="sd">    :param db_file: Path to SQLite database file.</span>
<span class="sd">    :param rep_colors_with_cont: Mapping for contaminant and non-contaminant colors by bait.</span>
<span class="sd">    :param figure_defaults: Figure defaults for plotting.</span>
<span class="sd">    :param isoform_agnostic: If ``True``, match using base UniProt IDs (no isoforms).</span>
<span class="sd">    :returns: Tuple of (plot Div, processed SAINT output JSON).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;known_plot - started: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">upid_a_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;uniprot_id_a&#39;</span>
    <span class="n">upid_b_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;uniprot_id_b&#39;</span>
    <span class="k">if</span> <span class="n">isoform_agnostic</span><span class="p">:</span>
        <span class="n">upid_a_col</span> <span class="o">+=</span> <span class="s1">&#39;_noiso&#39;</span>
        <span class="n">upid_b_col</span> <span class="o">+=</span> <span class="s1">&#39;_noiso&#39;</span>
    <span class="n">saint_output</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
        <span class="n">StringIO</span><span class="p">(</span><span class="n">filtered_saint_input_json</span><span class="p">),</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="n">db_conn</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
    <span class="n">col_order</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">saint_output</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">knowns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">get_from_table_by_list_criteria</span><span class="p">(</span>
        <span class="n">db_conn</span><span class="p">,</span> <span class="s1">&#39;known_interactions&#39;</span><span class="p">,</span> <span class="n">upid_a_col</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">saint_output</span><span class="p">[</span><span class="s1">&#39;Bait uniprot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="p">)</span>
    <span class="n">db_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># TODO: multibait</span>
    <span class="n">saint_output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">saint_output</span><span class="p">,</span>
        <span class="n">knowns</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Bait uniprot&#39;</span><span class="p">,</span> <span class="s1">&#39;Prey&#39;</span><span class="p">],</span>
        <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="n">upid_a_col</span><span class="p">,</span> <span class="n">upid_b_col</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
    <span class="p">)</span>
    <span class="n">saint_output</span><span class="p">[</span><span class="s1">&#39;Known interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">saint_output</span><span class="p">[</span><span class="s1">&#39;update_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;known_plot - knowns: </span><span class="si">{</span><span class="n">saint_output</span><span class="p">[</span><span class="s2">&quot;Known interaction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">col_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Known interaction&#39;</span><span class="p">)</span>
    <span class="n">col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">saint_output</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col_order</span><span class="p">])</span>
    <span class="n">saint_output</span> <span class="o">=</span> <span class="n">saint_output</span><span class="p">[</span><span class="n">col_order</span><span class="p">]</span>
    <span class="n">figure_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">count_knowns</span><span class="p">(</span>
        <span class="n">saint_output</span><span class="p">,</span> <span class="n">rep_colors_with_cont</span><span class="p">)</span>
    <span class="n">figure_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">,</span> <span class="s1">&#39;Known interaction&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span>
                            <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">figure_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">figure_data</span><span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">]</span>
    <span class="n">figure_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">bait_map</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">bu</span><span class="p">:</span> <span class="n">b</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">bu</span> <span class="ow">in</span> <span class="n">saint_output</span><span class="p">[[</span>
        <span class="s1">&#39;Bait&#39;</span><span class="p">,</span> <span class="s1">&#39;Bait uniprot&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">bu</span> <span class="o">!=</span> <span class="s1">&#39;No bait uniprot&#39;</span><span class="p">}</span>

    <span class="n">known_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Known interactions found per bait (Known / All):&#39;</span>
    <span class="n">no_knowns_found</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">done</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">bait</span> <span class="ow">in</span> <span class="n">figure_data</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bait</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bait</span><span class="p">)</span>
        <span class="n">bdata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">figure_data</span><span class="p">[</span><span class="n">figure_data</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">bait</span><span class="p">]</span>
        <span class="n">known_sum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="p">[</span><span class="s2">&quot;Known interaction&quot;</span><span class="p">]][</span><span class="s2">&quot;Prey count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">known_sum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">no_knowns_found</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bait</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">known_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bait</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">known_sum</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">bdata</span><span class="p">[</span><span class="s2">&quot;Prey count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s1">, &#39;</span>
    <span class="n">known_str</span> <span class="o">=</span> <span class="n">known_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;. &#39;</span>
    <span class="n">known_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;No known interactions found: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">no_knowns_found</span><span class="p">)))</span><span class="si">}</span><span class="s1">. &#39;</span>

    <span class="n">more_known</span> <span class="o">=</span> <span class="s1">&#39;Known preys available for these baits in the database: &#39;</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">knowns</span><span class="p">[</span><span class="n">upid_a_col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">more_known</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bait_map</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">), &#39;</span>
    <span class="n">more_known</span> <span class="o">=</span> <span class="n">more_known</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;. &#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_knowns_found</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">figure_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="n">more_known</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">figtitle</span> <span class="o">=</span> <span class="s1">&#39;High-confidence interactions and identified known interactions&#39;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;interactomics-saint-known-plot&#39;</span><span class="p">,</span>
            <span class="n">children</span><span class="o">=</span><span class="p">[</span>
                <span class="n">html</span><span class="o">.</span><span class="n">H4</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;interactomics-known-header&#39;</span><span class="p">,</span>
                        <span class="n">children</span><span class="o">=</span><span class="n">figtitle</span><span class="p">),</span>
                <span class="n">bar_graph</span><span class="o">.</span><span class="n">make_graph</span><span class="p">(</span>
                    <span class="s1">&#39;interactomics-saint-filt-int-known-graph&#39;</span><span class="p">,</span>
                    <span class="n">figure_defaults</span><span class="p">,</span>
                    <span class="n">figtitle</span><span class="p">,</span> 
                    <span class="n">figure_data</span><span class="p">,</span>
                    <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">color_discrete_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y_name</span><span class="o">=</span><span class="s1">&#39;Prey count&#39;</span><span class="p">,</span> <span class="n">x_label</span><span class="o">=</span><span class="s1">&#39;Bait&#39;</span>
                <span class="p">),</span>
                <span class="n">legends</span><span class="p">[</span><span class="s1">&#39;known&#39;</span><span class="p">],</span>
                <span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">known_str</span><span class="p">),</span>
                <span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">more_known</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;overflowX&#39;</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                <span class="s1">&#39;whiteSpace&#39;</span><span class="p">:</span> <span class="s1">&#39;nowrap&#39;</span>
            <span class="p">}</span>
        <span class="p">),</span>
        <span class="n">saint_output</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="p">)</span></div>




<div class="viewcode-block" id="pca">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.pca">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pca</span><span class="p">(</span><span class="n">saint_output_data</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">defaults</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
        <span class="n">replicate_colors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform PCA on SAINT output and plot bait relationships.</span>

<span class="sd">    :param saint_output_data: SAINT output in pandas split-JSON format.</span>
<span class="sd">    :param defaults: Figure defaults.</span>
<span class="sd">    :param replicate_colors: Mapping ``&#39;sample groups&#39;`` -&gt; color.</span>
<span class="sd">    :returns: Tuple of (plot Div, PCA data JSON). Returns empty plot if &lt;2 baits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">saint_output_data</span><span class="p">),</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_table</span><span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">gdiv</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Too few samle groups for PCA&#39;</span><span class="p">]</span>
        <span class="n">pca_data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_table</span> <span class="o">=</span> <span class="n">data_table</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="s1">&#39;Prey&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Bait&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;AvgSpec&#39;</span><span class="p">)</span>
        <span class="n">pc1</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">pc2</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">pca_result</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
        <span class="c1"># Compute PCA of the data</span>
        <span class="n">spoofed_sample_groups</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_table</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
        <span class="n">pc1</span><span class="p">,</span> <span class="n">pc2</span><span class="p">,</span> <span class="n">pca_result</span> <span class="o">=</span> <span class="n">matrix_functions</span><span class="o">.</span><span class="n">do_pca</span><span class="p">(</span>
            <span class="n">data_table</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">spoofed_sample_groups</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pca_result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">pc1</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pca_result</span><span class="p">[</span><span class="s1">&#39;Sample group color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">replicate_colors</span><span class="p">[</span><span class="s1">&#39;sample groups&#39;</span><span class="p">][</span><span class="n">grp</span><span class="p">]</span> <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">pca_result</span><span class="p">[</span><span class="s1">&#39;Sample group&#39;</span><span class="p">]]</span>
        <span class="n">dlname</span> <span class="o">=</span> <span class="s1">&#39;SPC PCA&#39;</span>
        <span class="n">gdiv</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">html</span><span class="o">.</span><span class="n">H4</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;interactomics-pca-header&#39;</span><span class="p">,</span> <span class="n">children</span><span class="o">=</span><span class="n">dlname</span><span class="p">),</span>
            <span class="n">scatter</span><span class="o">.</span><span class="n">make_graph</span><span class="p">(</span>
                <span class="s1">&#39;interactomics-pca-plot&#39;</span><span class="p">,</span>
                <span class="n">defaults</span><span class="p">,</span>
                <span class="n">dlname</span><span class="p">,</span>
                <span class="n">pca_result</span><span class="p">,</span>
                <span class="n">pc1</span><span class="p">,</span>
                <span class="n">pc2</span><span class="p">,</span>
                <span class="s1">&#39;Sample group color&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Sample group&#39;</span><span class="p">,</span>
                <span class="n">hover_data</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Sample group&#39;</span><span class="p">,</span> <span class="s1">&#39;Sample name&#39;</span><span class="p">,</span> <span class="n">pc1</span><span class="p">,</span><span class="n">pc2</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="n">legends</span><span class="p">[</span><span class="s1">&#39;pca&#39;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">pca_data</span> <span class="o">=</span> <span class="n">pca_result</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;interactomics-pca-plot-div&#39;</span><span class="p">,</span>
            <span class="n">children</span><span class="o">=</span><span class="n">gdiv</span>
        <span class="p">),</span>
        <span class="n">pca_data</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="enrich">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.enrich">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">enrich</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
          <span class="n">chosen_enrichments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
          <span class="n">figure_defaults</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
          <span class="n">keep_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
          <span class="n">sig_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
          <span class="n">parameters_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;config/parameters.toml&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run selected enrichment methods and visualize results.</span>

<span class="sd">    :param saint_output_json: SAINT output in pandas split-JSON format.</span>
<span class="sd">    :param chosen_enrichments: List of enrichment method names.</span>
<span class="sd">    :param figure_defaults: Figure defaults for plotting.</span>
<span class="sd">    :param keep_all: If ``True``, include non-significant rows meeting fold criteria.</span>
<span class="sd">    :param sig_threshold: Significance cutoff.</span>
<span class="sd">    :param parameters_file: Path to parameters TOML used by enrichment admin.</span>
<span class="sd">    :returns: Tuple of (list of result Divs, dict of enrichment data, list of info).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">div_contents</span><span class="p">:</span><span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">enrichment_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">enrichment_information</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chosen_enrichments</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">chosen_enrichments</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_enrichments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">div_contents</span><span class="p">,</span>
            <span class="n">enrichment_data</span><span class="p">,</span>
            <span class="n">enrichment_information</span>
        <span class="p">)</span>   
    <span class="n">e_admin</span> <span class="o">=</span> <span class="n">ea</span><span class="o">.</span><span class="n">EnrichmentAdmin</span><span class="p">(</span><span class="n">parameters_file</span><span class="p">)</span>
    <span class="n">saint_output</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
        <span class="n">StringIO</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">),</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="n">enrichment_names</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">enrichment_results</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">enrichment_names</span><span class="p">,</span> <span class="n">enrichment_results</span><span class="p">,</span> <span class="n">enrichment_information</span> <span class="o">=</span> <span class="n">e_admin</span><span class="o">.</span><span class="n">enrich_all</span><span class="p">(</span>
        <span class="n">saint_output</span><span class="p">,</span>
        <span class="n">chosen_enrichments</span><span class="p">,</span>
        <span class="n">id_column</span><span class="o">=</span><span class="s1">&#39;Prey&#39;</span><span class="p">,</span>
        <span class="n">split_by_column</span><span class="o">=</span><span class="s1">&#39;Bait&#39;</span><span class="p">,</span>
        <span class="n">split_name</span><span class="o">=</span><span class="s1">&#39;Bait&#39;</span>
    <span class="p">)</span>

    <span class="n">tablist</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">rescol</span><span class="p">,</span> <span class="n">sigcol</span><span class="p">,</span> <span class="n">namecol</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">enrichment_results</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keep_all</span><span class="p">:</span>
            <span class="n">keep_these</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">rescol</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">][</span><span class="n">namecol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">keep_these</span> <span class="o">=</span> <span class="n">keep_these</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">sigcol</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sig_threshold</span><span class="p">][</span><span class="n">namecol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">filtered_result</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">namecol</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                <span class="n">keep_these</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filtered_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[(</span><span class="n">result</span><span class="p">[</span><span class="n">sigcol</span><span class="p">]</span><span class="o">&lt;</span><span class="n">sig_threshold</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">rescol</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">)]</span>
        <span class="n">matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
            <span class="n">filtered_result</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">namecol</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Bait&#39;</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="n">rescol</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filtered_result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;Nothing enriched.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">enrichment_data</span><span class="p">[</span><span class="n">enrichment_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;sigcol&#39;</span><span class="p">:</span> <span class="n">sigcol</span><span class="p">,</span>
                <span class="s1">&#39;rescol&#39;</span><span class="p">:</span> <span class="n">rescol</span><span class="p">,</span>
                <span class="s1">&#39;namecol&#39;</span><span class="p">:</span> <span class="n">namecol</span><span class="p">,</span>
                <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">heatmaps</span><span class="o">.</span><span class="n">make_heatmap_graph</span><span class="p">(</span>
                <span class="n">matrix</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;interactomics-enrichment-</span><span class="si">{</span><span class="n">enrichment_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">rescol</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">),</span>
                <span class="n">figure_defaults</span><span class="p">,</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;dense&#39;</span><span class="p">,</span>
                <span class="n">dlname</span> <span class="o">=</span> <span class="n">enrichment_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">symmetrical</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="p">)</span>

        <span class="n">table_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">enrichment_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> data table&#39;</span>
        <span class="n">table</span><span class="p">:</span> <span class="n">dash_table</span><span class="o">.</span><span class="n">DataTable</span> <span class="o">=</span> <span class="n">dash_table</span><span class="o">.</span><span class="n">DataTable</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">filtered_result</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">),</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_result</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span>
            <span class="n">page_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">style_table</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;maxHeight&#39;</span><span class="p">:</span> <span class="mi">600</span>
            <span class="p">},</span>
            <span class="n">style_data</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;100px&#39;</span><span class="p">,</span> <span class="s1">&#39;minWidth&#39;</span><span class="p">:</span> <span class="s1">&#39;25px&#39;</span><span class="p">,</span> <span class="s1">&#39;maxWidth&#39;</span><span class="p">:</span> <span class="s1">&#39;250px&#39;</span><span class="p">,</span>
                <span class="s1">&#39;overflow&#39;</span><span class="p">:</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span>
                <span class="s1">&#39;textOverflow&#39;</span><span class="p">:</span> <span class="s1">&#39;ellipsis&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">filter_action</span><span class="o">=</span><span class="s1">&#39;native&#39;</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;interactomics-enrichment-</span><span class="si">{</span><span class="n">table_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">e_legend</span><span class="p">:</span> <span class="n">html</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">enrichment_legend</span><span class="p">(</span>
            <span class="n">replace_accent_and_special_characters</span><span class="p">(</span><span class="n">enrichment_names</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="n">enrichment_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">rescol</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">sigcol</span><span class="p">,</span>
            <span class="n">sig_threshold</span>
        <span class="p">)</span>
        <span class="n">enrichment_tab</span><span class="p">:</span> <span class="n">Card</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span>
            <span class="n">CardBody</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">H5</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">enrichment_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> heatmap&#39;</span><span class="p">),</span>
                    <span class="n">graph</span><span class="p">,</span>
                    <span class="n">e_legend</span><span class="p">,</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">enrichment_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> data table&#39;</span><span class="p">),</span>
                    <span class="n">table</span>
                <span class="p">],</span>
             <span class="c1">#   style={&#39;width&#39;: &#39;98%&#39;}</span>
            <span class="p">),</span>
            <span class="c1">#style={&#39;width&#39;: &#39;98%&#39;}</span>
        <span class="p">)</span>

        <span class="n">tablist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Tab</span><span class="p">(</span>
                <span class="n">enrichment_tab</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">enrichment_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
               <span class="c1"># style={&#39;width&#39;: &#39;98%&#39;}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">enrichment_results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">div_contents</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">html</span><span class="o">.</span><span class="n">H4</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;interactomics-enrichment-header&#39;</span><span class="p">,</span> <span class="n">children</span><span class="o">=</span><span class="s1">&#39;Enrichment&#39;</span><span class="p">),</span>
            <span class="n">Tabs</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;interactomics-enrichment-tabs&#39;</span><span class="p">,</span>
                <span class="n">children</span><span class="o">=</span><span class="n">tablist</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;98%&#39;</span><span class="p">}</span>
            <span class="p">)]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">div_contents</span><span class="p">,</span>
        <span class="n">enrichment_data</span><span class="p">,</span>
        <span class="n">enrichment_information</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="map_intensity">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.map_intensity">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">map_intensity</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                 <span class="n">intensity_table_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                 <span class="n">sample_groups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Map averaged intensity per group onto SAINT output rows.</span>

<span class="sd">    :param saint_output_json: SAINT output in pandas split-JSON format.</span>
<span class="sd">    :param intensity_table_json: Intensity table in pandas split-JSON format.</span>
<span class="sd">    :param sample_groups: Mapping bait -&gt; group name.</span>
<span class="sd">    :returns: SAINT output JSON with optional ``Averaged intensity`` column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intensity_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
        <span class="n">StringIO</span><span class="p">(</span><span class="n">intensity_table_json</span><span class="p">),</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="n">saint_output</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
        <span class="n">StringIO</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">),</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="n">has_intensity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">intensity_column</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">saint_output</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">intensity_table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">intensity_table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">intensity_table</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;No data&#39;</span><span class="p">:</span>
                <span class="n">has_intensity</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">has_intensity</span><span class="p">:</span>
        <span class="n">intensity_column</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">saint_output</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">intensity_column</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">intensity_table</span><span class="p">[</span><span class="n">sample_groups</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">]]]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Prey&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">intensity_column</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">saint_output</span><span class="p">[</span><span class="s1">&#39;Averaged intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity_column</span>
    <span class="k">return</span> <span class="n">saint_output</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="saint_histogram">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.saint_histogram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">saint_histogram</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                   <span class="n">figure_defaults</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a histogram of BFDR scores from SAINT output.</span>

<span class="sd">    :param saint_output_json: SAINT output in pandas split-JSON format.</span>
<span class="sd">    :param figure_defaults: Figure defaults for plotting.</span>
<span class="sd">    :returns: Tuple of (histogram Div, histogram data JSON).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">saint_output</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
        <span class="n">StringIO</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">),</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">histogram</span><span class="o">.</span><span class="n">make_figure</span><span class="p">(</span><span class="n">saint_output</span><span class="p">,</span> <span class="s1">&#39;BFDR&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">figure_defaults</span><span class="p">),</span>
        <span class="n">saint_output</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="add_bait_column">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.add_bait_column">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_bait_column</span><span class="p">(</span><span class="n">saint_output</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                    <span class="n">bait_uniprot_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add bait UniProt and bait-self flags to SAINT output.</span>

<span class="sd">    :param saint_output: SAINT output DataFrame with ``Bait`` and ``Prey``.</span>
<span class="sd">    :param bait_uniprot_dict: Mapping bait name -&gt; UniProt IDs (``;`` separated allowed).</span>
<span class="sd">    :returns: DataFrame with ``Bait uniprot`` and ``Prey is bait`` added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">saint_output</span><span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">saint_output</span><span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="n">bu_column</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prey_is_bait</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">saint_output</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bait_uniprot_dict</span><span class="p">:</span>
            <span class="n">bu_column</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bait_uniprot_dict</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">]])</span>
            <span class="n">prey_is_bait</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Prey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bu_column</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bu_column</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;No bait uniprot&#39;</span><span class="p">)</span>
            <span class="n">prey_is_bait</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">saint_output</span><span class="p">[</span><span class="s1">&#39;Bait uniprot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bu_column</span>
    <span class="n">saint_output</span><span class="p">[</span><span class="s1">&#39;Prey is bait&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prey_is_bait</span>
    <span class="k">return</span> <span class="n">saint_output</span></div>


<div class="viewcode-block" id="saint_cmd">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.saint_cmd">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">saint_cmd</span><span class="p">(</span><span class="n">saint_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span> 
             <span class="n">saint_tempdir</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
             <span class="n">session_uid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run SAINTexpressSpc on prepared input files.</span>

<span class="sd">    :param saint_input: Dict with keys ``bait``, ``prey``, ``int`` containing row lists.</span>
<span class="sd">    :param saint_tempdir: List of path segments for temp dir base.</span>
<span class="sd">    :param session_uid: Unique identifier to isolate run directory.</span>
<span class="sd">    :returns: Path to directory containing ``list.txt`` (or dummy if SAINT missing).</span>
<span class="sd">    :raises OSError: On temp dir creation failure.</span>
<span class="sd">    :raises sh.CommandNotFound: If SAINTexpressSpc is not available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">saint_tempdir</span><span class="p">))</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">session_uid</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
    <span class="k">with</span> <span class="p">(</span>
        <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">baitfile</span><span class="p">,</span>
        <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">preyfile</span><span class="p">,</span>
        <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">intfile</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">baitfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">saint_input</span><span class="p">[</span><span class="s1">&#39;bait&#39;</span><span class="p">]</span>
            <span class="p">]))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">preyfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">saint_input</span><span class="p">[</span><span class="s1">&#39;prey&#39;</span><span class="p">]</span>
            <span class="p">]))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">intfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">saint_input</span><span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">]</span>
            <span class="p">]))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">baitfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">preyfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">intfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sh</span><span class="o">.</span><span class="n">SAINTexpressSpc</span><span class="p">(</span><span class="n">intfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">preyfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">baitfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_cwd</span><span class="o">=</span><span class="n">temp_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sh</span><span class="o">.</span><span class="n">CommandNotFound</span><span class="p">:</span>
            <span class="n">create_dummy_list_txt</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">saint_input</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">temp_dir</span></div>


<div class="viewcode-block" id="create_dummy_list_txt">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.create_dummy_list_txt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_dummy_list_txt</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">saint_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a dummy SAINT ``list.txt`` when SAINTexpressSpc is unavailable.</span>

<span class="sd">    Generates a plausible-looking SAINT output file using random values so that</span>
<span class="sd">    downstream steps can proceed in demo or fallback mode.</span>

<span class="sd">    :param temp_dir: Target directory to write ``list.txt`` and marker file.</span>
<span class="sd">    :param saint_input: SAINT input dict with keys ``bait``, ``prey``, ``int``.</span>
<span class="sd">    :returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">baits</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">baitmap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">baitrun</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">saint_input</span><span class="p">[</span><span class="s1">&#39;bait&#39;</span><span class="p">]:</span>
        <span class="n">baits</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">baits</span><span class="p">[</span><span class="n">ctrl</span><span class="p">][</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">baitrun</span><span class="p">)</span>
        <span class="n">baitmap</span><span class="p">[</span><span class="n">baitrun</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

    <span class="n">preys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">prey</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">gname</span> <span class="ow">in</span> <span class="n">saint_input</span><span class="p">[</span><span class="s1">&#39;prey&#39;</span><span class="p">]:</span>
        <span class="n">preys</span><span class="p">[</span><span class="n">prey</span><span class="p">]</span> <span class="o">=</span> <span class="n">gname</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">max_b_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">baitrun</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">prey</span><span class="p">,</span> <span class="n">spc</span> <span class="ow">in</span> <span class="n">saint_input</span><span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">]:</span>
        <span class="n">counts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">prey</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">counts</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">prey</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc</span><span class="p">)</span>
        <span class="n">max_b_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_b_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">prey</span><span class="p">]))</span>

    <span class="n">control_counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">max_ctrl_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">baitgrp</span> <span class="ow">in</span> <span class="n">baits</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">prey</span><span class="p">,</span> <span class="n">spc</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">[</span><span class="n">baitgrp</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">control_counts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">prey</span><span class="p">,[])</span>
            <span class="n">control_counts</span><span class="p">[</span><span class="n">prey</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">spc</span><span class="p">)</span>
            <span class="n">max_ctrl_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_ctrl_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_counts</span><span class="p">[</span><span class="n">prey</span><span class="p">]))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pad</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="n">le</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">le</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">li</span>
        <span class="n">rlist</span> <span class="o">=</span> <span class="n">li</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">),</span> <span class="n">le</span><span class="p">):</span>
            <span class="n">rlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rlist</span>

    <span class="n">list_txt</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">pdic</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">baits</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]:</span> <span class="k">continue</span>
        <span class="k">for</span> <span class="n">prey</span><span class="p">,</span> <span class="n">spclist</span> <span class="ow">in</span> <span class="n">pdic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">bfdr_random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
            <span class="n">score_random</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">bfdr_random</span><span class="o">*</span><span class="mi">3</span>
            <span class="n">p_ctrl_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">prey</span> <span class="ow">in</span> <span class="n">control_counts</span><span class="p">:</span>
                <span class="n">p_ctrl_list</span> <span class="o">=</span> <span class="n">control_counts</span><span class="p">[</span><span class="n">prey</span><span class="p">]</span>
            <span class="n">spclist</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">spclist</span><span class="p">,</span> <span class="n">max_b_len</span><span class="p">)</span>
            <span class="n">p_ctrl_list</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">p_ctrl_list</span><span class="p">,</span> <span class="n">max_ctrl_len</span><span class="p">)</span>
            <span class="n">list_txt</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="n">group</span><span class="p">,</span>
                <span class="n">prey</span><span class="p">,</span> 
                <span class="n">preys</span><span class="p">[</span><span class="n">prey</span><span class="p">],</span> 
                <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spclist</span><span class="p">),</span> 
                <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spc</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">spc</span><span class="p">),</span>
                <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spc</span><span class="p">]),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">baits</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="n">group</span><span class="p">]),</span>
                <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p_ctrl_list</span><span class="p">),</span>
                <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">score_random</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="n">bfdr_random</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">list_txt</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">,</span> <span class="s1">&#39;Prey&#39;</span><span class="p">,</span> <span class="s1">&#39;PreyGene&#39;</span><span class="p">,</span> <span class="s1">&#39;Spec&#39;</span><span class="p">,</span> <span class="s1">&#39;SpecSum&#39;</span><span class="p">,</span> <span class="s1">&#39;AvgSpec&#39;</span><span class="p">,</span> <span class="s1">&#39;NumReplicates&#39;</span><span class="p">,</span> <span class="s1">&#39;ctrlCounts&#39;</span><span class="p">,</span> <span class="s1">&#39;AvgP&#39;</span><span class="p">,</span> <span class="s1">&#39;MaxP&#39;</span><span class="p">,</span> <span class="s1">&#39;TopoAvgP&#39;</span><span class="p">,</span> <span class="s1">&#39;TopoMaxP&#39;</span><span class="p">,</span> <span class="s1">&#39;SaintScore&#39;</span><span class="p">,</span> <span class="s1">&#39;FoldChange&#39;</span><span class="p">,</span> <span class="s1">&#39;BFDR&#39;</span><span class="p">,</span> <span class="s1">&#39;boosted_by&#39;</span><span class="p">])</span>
    <span class="n">lt</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;list.txt&#39;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;list_is_dummy.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;this list has been created by dummy saint simulator that produces nonsense. This happened because SAINTexpressSpc was not found.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_saint">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.run_saint">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_saint</span><span class="p">(</span><span class="n">saint_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span> 
             <span class="n">saint_tempdir</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
             <span class="n">session_uid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
             <span class="n">bait_uniprots</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> 
             <span class="n">cleanup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute SAINT pipeline and return processed output.</span>

<span class="sd">    :param saint_input: SAINT input dict.</span>
<span class="sd">    :param saint_tempdir: Temp directory base as path segments.</span>
<span class="sd">    :param session_uid: Unique run identifier.</span>
<span class="sd">    :param bait_uniprots: Mapping bait -&gt; UniProt IDs.</span>
<span class="sd">    :param cleanup: If ``True``, remove temp files after success.</span>
<span class="sd">    :returns: Tuple of (output JSON or error string, saint_missing_flag).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Can not use logging in this function, since it&#39;s called from a background_callback_manager using celery, and logging will lead to a hang.</span>
    <span class="c1"># Instead, we can use print statements, and they will show up as WARNINGS in celery log.</span>
    <span class="n">temp_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;bait&#39;</span> <span class="ow">in</span> <span class="n">saint_input</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;prey&#39;</span> <span class="ow">in</span> <span class="n">saint_input</span><span class="p">):</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">saint_cmd</span><span class="p">(</span><span class="n">saint_input</span><span class="p">,</span> <span class="n">saint_tempdir</span><span class="p">,</span> <span class="n">session_uid</span><span class="p">)</span>
    <span class="n">failed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;list.txt&#39;</span><span class="p">))</span>
    <span class="n">saintfail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;list_is_dummy.txt&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">failed</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SAINT failed. Can not proceed.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">add_bait_column</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;list.txt&#39;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">bait_uniprots</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cleanup</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">PermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;run_saint:  Could not clean up after SAINT run: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">saintfail</span><span class="p">)</span></div>



<div class="viewcode-block" id="prepare_crapome">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.prepare_crapome">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_crapome</span><span class="p">(</span><span class="n">db_conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> 
                   <span class="n">crapomes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare CRAPome tables for downstream filtering.</span>

<span class="sd">    :param db_conn: SQLite connection.</span>
<span class="sd">    :param crapomes: List of CRAPome table names (possibly with suffixes).</span>
<span class="sd">    :returns: DataFrame with per-CRAPome frequency and spc averages plus max frequency.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">crapomes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_(&#39;</span><span class="p">,</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">crapomes</span><span class="p">]</span>
    <span class="n">crapome_tables</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">db_functions</span><span class="o">.</span><span class="n">get_full_table_as_pd</span><span class="p">(</span><span class="n">db_conn</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;protein_id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">crapomes</span>
    <span class="p">]</span>
    <span class="n">crapome_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">crapome_tables</span><span class="p">[</span><span class="n">i</span><span class="p">][[</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;spc_avg&#39;</span><span class="p">]]</span><span class="o">.</span>
            <span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s1">_frequency&#39;</span><span class="p">,</span>
                <span class="s1">&#39;spc_avg&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s1">_spc_avg&#39;</span>
            <span class="p">})</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">crapomes</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">crapome_freq_cols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">crapome_table</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;_frequency&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
    <span class="n">crapome_table</span><span class="p">[</span><span class="s1">&#39;Max crapome frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crapome_table</span><span class="p">[</span><span class="n">crapome_freq_cols</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">crapome_table</span></div>


<div class="viewcode-block" id="prepare_controls">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.prepare_controls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_controls</span><span class="p">(</span><span class="n">input_data_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
                    <span class="n">uploaded_controls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                    <span class="n">additional_controls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                    <span class="n">db_conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> 
                    <span class="n">select_most_similar_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                    <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assemble uploaded and DB controls for SAINT.</span>

<span class="sd">    :param input_data_dict: Inputs including sample groups and SPC data tables.</span>
<span class="sd">    :param uploaded_controls: Names of uploaded control groups.</span>
<span class="sd">    :param additional_controls: Additional DB control table names.</span>
<span class="sd">    :param db_conn: SQLite connection.</span>
<span class="sd">    :param select_most_similar_only: If ``True``, keep only most similar controls.</span>
<span class="sd">    :param top_n: Number of controls to keep per-sample when filtering.</span>
<span class="sd">    :returns: Tuple of (SPC table without control columns, combined control table).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;additional controls: </span><span class="si">{</span><span class="n">additional_controls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">additional_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_(&#39;</span><span class="p">,</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">additional_controls</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;preparing uploaded controls: </span><span class="si">{</span><span class="n">uploaded_controls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;preparing additional controls: </span><span class="si">{</span><span class="n">additional_controls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sample_groups</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">input_data_dict</span><span class="p">[</span><span class="s1">&#39;sample groups&#39;</span><span class="p">][</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span>
    <span class="n">spc_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
        <span class="n">StringIO</span><span class="p">(</span><span class="n">input_data_dict</span><span class="p">[</span><span class="s1">&#39;data tables&#39;</span><span class="p">][</span><span class="s1">&#39;spc&#39;</span><span class="p">]),</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="n">controls</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">control_name</span> <span class="ow">in</span> <span class="n">additional_controls</span><span class="p">:</span>
        <span class="n">ctable</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">get_full_table_as_pd</span><span class="p">(</span>
            <span class="n">db_conn</span><span class="p">,</span> <span class="n">control_name</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;PROTID&#39;</span><span class="p">)</span>
        <span class="n">ctable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctable</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;control </span><span class="si">{</span><span class="n">control_name</span><span class="si">}</span><span class="s1"> shape: </span><span class="si">{</span><span class="n">ctable</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, indexvals: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ctable</span><span class="o">.</span><span class="n">index</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">select_most_similar_only</span><span class="p">:</span>
        <span class="c1"># groupby to merge possible duplicate columns that are annotated in multiple sets</span>
        <span class="c1"># mean grouping should have no effect, since PSM values SHOULD be the same in any case.</span>
        <span class="n">control_table</span> <span class="o">=</span> <span class="n">filter_controls_by_similarity</span><span class="p">(</span><span class="n">spc_table</span><span class="p">,</span> <span class="n">controls</span><span class="p">,</span> <span class="n">top_n</span><span class="p">)</span>
        <span class="n">controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">control_table</span><span class="p">]</span>
    <span class="n">control_cols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cg</span> <span class="ow">in</span> <span class="n">uploaded_controls</span><span class="p">:</span>
        <span class="n">control_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sample_groups</span><span class="p">[</span><span class="n">cg</span><span class="p">])</span>
    <span class="n">controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc_table</span><span class="p">[</span><span class="n">control_cols</span><span class="p">])</span>
    <span class="n">spc_table</span> <span class="o">=</span> <span class="n">spc_table</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">spc_table</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">control_cols</span><span class="p">]]</span>
    <span class="n">control_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">controls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Controls concatenated: </span><span class="si">{</span><span class="n">control_table</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, indexvals: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">control_table</span><span class="o">.</span><span class="n">index</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SPC table index: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">spc_table</span><span class="o">.</span><span class="n">index</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># Discard any control preys that are not identified in baits. It will not affect SAINT results.</span>
    <span class="n">control_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">control_table</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span>
                       <span class="nb">set</span><span class="p">(</span><span class="n">spc_table</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;non-detected preys dropped: </span><span class="si">{</span><span class="n">control_table</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">spc_table</span><span class="p">,</span> <span class="n">control_table</span><span class="p">)</span></div>


<div class="viewcode-block" id="filter_controls_by_similarity">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.filter_controls_by_similarity">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">filter_controls_by_similarity</span><span class="p">(</span><span class="n">spc_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                   <span class="n">controls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> 
                   <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter control runs by similarity to experiment runs.</span>

<span class="sd">    :param spc_table: Spectral count table for experiment samples.</span>
<span class="sd">    :param controls: List of candidate control tables.</span>
<span class="sd">    :param top_n: Number of top similar controls to keep per sample.</span>
<span class="sd">    :returns: Filtered control table with selected columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">control_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">controls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="n">chosen_controls</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">spc_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">controls_ranked_by_similarity</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">matrix_functions</span><span class="o">.</span><span class="n">ranked_dist</span><span class="p">(</span>
            <span class="n">spc_table</span><span class="p">[[</span><span class="n">c</span><span class="p">]],</span> <span class="n">control_table</span><span class="p">)</span>
        <span class="n">chosen_controls</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">controls_ranked_by_similarity</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]])</span>
    <span class="n">control_table</span> <span class="o">=</span> <span class="n">control_table</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">chosen_controls</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">control_table</span></div>


<div class="viewcode-block" id="add_crapome">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.add_crapome">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_crapome</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                <span class="n">crapome_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge CRAPome annotations into SAINT output JSON.</span>

<span class="sd">    :param saint_output_json: SAINT output in pandas split-JSON format.</span>
<span class="sd">    :param crapome_json: CRAPome table in pandas split-JSON format.</span>
<span class="sd">    :returns: Merged SAINT output JSON.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;Saint failed.&#39;</span> <span class="ow">in</span> <span class="n">saint_output_json</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">saint_output_json</span>
    <span class="n">saint_output</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
        <span class="n">StringIO</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">),</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="n">crapome</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">crapome_json</span><span class="p">),</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">saint_output</span><span class="p">,</span>
        <span class="n">crapome</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;Prey&#39;</span><span class="p">,</span>
        <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="make_saint_dict">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.make_saint_dict">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_saint_dict</span><span class="p">(</span><span class="n">spc_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                   <span class="n">rev_sample_groups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> 
                   <span class="n">control_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                   <span class="n">protein_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create SAINT input dict from SPC and metadata tables.</span>

<span class="sd">    :param spc_table: Spectral count data.</span>
<span class="sd">    :param rev_sample_groups: Mapping sample -&gt; group.</span>
<span class="sd">    :param control_table: Control spectral count table.</span>
<span class="sd">    :param protein_table: Protein info with columns ``uniprot_id``, ``length``, ``gene_name``.</span>
<span class="sd">    :returns: Dict with keys ``bait``, ``prey``, ``int`` as lists of rows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">protein_lenghts_and_names</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;make_saint_dict: start: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">protein_table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">protein_lenghts_and_names</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;uniprot_id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">],</span> <span class="s1">&#39;gene name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;gene_name&#39;</span><span class="p">]}</span>

    <span class="n">bait</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prey</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inter</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">spc_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">bait</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">col</span><span class="p">,</span> <span class="n">rev_sample_groups</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_bait&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">control_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">rev_sample_groups</span><span class="p">:</span>
            <span class="n">bait</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">col</span><span class="p">,</span> <span class="n">rev_sample_groups</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_bait&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bait</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;inbuilt_ctrl&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;make_saint_dict: Baits prepared: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;make_saint_dict: Control table shape: </span><span class="si">{</span><span class="n">control_table</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">control_melt</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">control_table</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">sgroups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">srow</span> <span class="ow">in</span> <span class="n">control_melt</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">sgroup</span> <span class="o">=</span> <span class="s1">&#39;inbuilt_ctrl&#39;</span>
        <span class="k">if</span> <span class="n">srow</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rev_sample_groups</span><span class="p">:</span>
            <span class="n">sgroup</span> <span class="o">=</span> <span class="n">rev_sample_groups</span><span class="p">[</span><span class="n">srow</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]]</span><span class="o">+</span><span class="s1">&#39;_bait&#39;</span>
        <span class="n">sgroups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sgroup</span><span class="p">)</span>
    <span class="n">control_melt</span><span class="p">[</span><span class="s1">&#39;sgroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sgroups</span>
    <span class="n">control_melt</span> <span class="o">=</span> <span class="n">control_melt</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;sgroup&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">])</span>
    <span class="n">control_melt</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_melt</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">inter</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">control_melt</span><span class="o">.</span><span class="n">values</span>
                 <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;make_saint_dict: Control table melted: </span><span class="si">{</span><span class="n">control_melt</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;make_saint_dict: Control interactions prepared: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">uniprot</span><span class="p">,</span> <span class="n">srow</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">spc_table</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">sgroup</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;inbuilt_ctrl&#39;</span>
        <span class="k">if</span> <span class="n">srow</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rev_sample_groups</span><span class="p">:</span>
            <span class="n">sgroup</span> <span class="o">=</span> <span class="n">rev_sample_groups</span><span class="p">[</span><span class="n">srow</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]]</span><span class="o">+</span><span class="s1">&#39;_bait&#39;</span>
        <span class="n">inter</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">srow</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">sgroup</span><span class="p">,</span> <span class="n">uniprot</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">srow</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;make_saint_dict: SPC table interactions prepared: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">uniprotid</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">control_table</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">spc_table</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plen</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">protein_lenghts_and_names</span><span class="p">[</span><span class="n">uniprotid</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>
            <span class="n">gname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">protein_lenghts_and_names</span><span class="p">[</span><span class="n">uniprotid</span><span class="p">][</span><span class="s1">&#39;gene name&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;make_saint_dict: No length found for uniprot: </span><span class="si">{</span><span class="n">uniprotid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">plen</span> <span class="o">=</span> <span class="s1">&#39;200&#39;</span>
            <span class="n">gname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uniprotid</span><span class="p">)</span>
        <span class="n">prey</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">uniprotid</span><span class="p">),</span> <span class="n">plen</span><span class="p">,</span> <span class="n">gname</span><span class="p">])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;make_saint_dict: Preys prepared: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bait&#39;</span><span class="p">:</span> <span class="n">bait</span><span class="p">,</span> <span class="s1">&#39;prey&#39;</span><span class="p">:</span> <span class="n">prey</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span> <span class="n">inter</span><span class="p">}</span></div>


<div class="viewcode-block" id="do_ms_microscopy">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.do_ms_microscopy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">do_ms_microscopy</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                    <span class="n">db_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                    <span class="n">figure_defaults</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
                    <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;v1.0&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform MS-microscopy localization analysis and visualize.</span>

<span class="sd">    :param saint_output_json: SAINT output in pandas split-JSON format.</span>
<span class="sd">    :param db_file: SQLite DB path for MS-microscopy reference.</span>
<span class="sd">    :param figure_defaults: Figure defaults.</span>
<span class="sd">    :param version: Analysis version tag.</span>
<span class="sd">    :returns: Tuple of (plots Div, results JSON).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">saint_output</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
        <span class="n">StringIO</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">),</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span>
    <span class="p">)</span>
    <span class="n">db_conn</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
    <span class="n">msmic_reference</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">get_full_table_as_pd</span><span class="p">(</span>
        <span class="n">db_conn</span><span class="p">,</span> <span class="s1">&#39;msmicroscopy&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;Interaction&#39;</span>
    <span class="p">)</span>
    <span class="n">db_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># type: ignore</span>
    <span class="n">msmic_results</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">ms_microscopy</span><span class="o">.</span><span class="n">generate_msmic_dataframes</span><span class="p">(</span><span class="n">saint_output</span><span class="p">,</span> <span class="n">msmic_reference</span><span class="p">,</span> <span class="p">)</span>

    <span class="n">polar_plots</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">bait</span><span class="p">,</span> <span class="n">ms_microscopy</span><span class="o">.</span><span class="n">localization_graph</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;interactomics-msmic-</span><span class="si">{</span><span class="n">bait</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">figure_defaults</span><span class="p">,</span> <span class="s1">&#39;polar&#39;</span><span class="p">,</span> <span class="n">bait</span><span class="p">,</span> <span class="n">data_row</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">bait</span><span class="p">,</span> <span class="n">data_row</span> <span class="ow">in</span> <span class="n">msmic_results</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="n">msmic_heatmap</span> <span class="o">=</span> <span class="n">ms_microscopy</span><span class="o">.</span><span class="n">localization_graph</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;interactomics-msmic-heatmap&#39;</span><span class="p">,</span> <span class="n">figure_defaults</span><span class="p">,</span> <span class="s1">&#39;heatmap&#39;</span><span class="p">,</span> <span class="s1">&#39;All baits&#39;</span><span class="p">,</span> <span class="n">msmic_results</span><span class="p">)</span>

    <span class="n">tablist</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Tab</span><span class="p">(</span>
            <span class="n">Card</span><span class="p">(</span>
                <span class="n">CardBody</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">html</span><span class="o">.</span><span class="n">H5</span><span class="p">(</span><span class="s1">&#39;MS-microscopy heatmap&#39;</span><span class="p">),</span>
                        <span class="n">msmic_heatmap</span><span class="p">,</span> 
                        <span class="n">legends</span><span class="p">[</span><span class="s1">&#39;ms-microscopy-all&#39;</span><span class="p">]</span>
                    <span class="p">],</span>
          <span class="c1">#          style={&#39;width&#39;: &#39;98%&#39;}</span>
                <span class="p">),</span>
         <span class="c1">#       style={&#39;width&#39;: &#39;98%&#39;}</span>
            <span class="p">),</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Overall results&#39;</span><span class="p">,</span>
        <span class="c1">#style={&#39;width&#39;: &#39;98%&#39;}</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">bait</span><span class="p">,</span> <span class="n">polar_graph</span> <span class="ow">in</span> <span class="n">polar_plots</span><span class="p">:</span>
        <span class="n">tablist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Tab</span><span class="p">(</span>
                <span class="n">Card</span><span class="p">(</span>
                    <span class="n">CardBody</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">html</span><span class="o">.</span><span class="n">H5</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MS-microscopy for </span><span class="si">{</span><span class="n">bait</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
                            <span class="n">polar_graph</span><span class="p">,</span>
                            <span class="n">leg_rep</span><span class="p">(</span>
                                <span class="n">legends</span><span class="p">[</span><span class="s1">&#39;ms-microscopy-single&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;BAITSTRING&#39;</span><span class="p">,</span>
                                <span class="n">bait</span>
                            <span class="p">)</span>
                        <span class="p">],</span>
                <span class="c1">#        style={&#39;width&#39;: &#39;98%&#39;}</span>
                    <span class="p">),</span>
                <span class="c1">#style={&#39;width&#39;: &#39;98%&#39;}</span>
                <span class="p">),</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">bait</span><span class="p">,</span>
                <span class="c1">#style={&#39;width&#39;: &#39;98%&#39;}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;interactomics-msmicroscopy-plot-div&#39;</span><span class="p">,</span>
            <span class="n">children</span><span class="o">=</span><span class="p">[</span>
                <span class="n">html</span><span class="o">.</span><span class="n">H4</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;interactomics-msmic-header&#39;</span><span class="p">,</span> <span class="n">children</span><span class="o">=</span><span class="s1">&#39;MS-microscopy&#39;</span><span class="p">),</span>
                <span class="n">Tabs</span><span class="p">(</span>
                    <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;interactomics-msmicroscopy-tabs&#39;</span><span class="p">,</span>
                    <span class="n">children</span> <span class="o">=</span> <span class="n">tablist</span><span class="p">,</span>
                    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;98%&#39;</span><span class="p">}</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">msmic_results</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="generate_saint_container">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.generate_saint_container">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_saint_container</span><span class="p">(</span><span class="n">input_data_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
                           <span class="n">uploaded_controls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                           <span class="n">additional_controls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                           <span class="n">crapomes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                           <span class="n">db_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                           <span class="n">select_most_similar_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                           <span class="n">n_controls</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build SAINT UI container and prepare inputs.</span>

<span class="sd">    :param input_data_dict: Input data and metadata including sample groups.</span>
<span class="sd">    :param uploaded_controls: Uploaded control group names.</span>
<span class="sd">    :param additional_controls: Additional DB control names.</span>
<span class="sd">    :param crapomes: CRAPome dataset names.</span>
<span class="sd">    :param db_file: SQLite database path.</span>
<span class="sd">    :param select_most_similar_only: If ``True``, filter controls by similarity.</span>
<span class="sd">    :param n_controls: Number of controls to keep when filtering.</span>
<span class="sd">    :returns: Tuple of (container Div, SAINT input dict, CRAPome JSON).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;[&quot;No data&quot;]&#39;</span> <span class="ow">in</span> <span class="n">input_data_dict</span><span class="p">[</span><span class="s1">&#39;data tables&#39;</span><span class="p">][</span><span class="s1">&#39;spc&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span><span class="s1">&#39;No spectral count data in input, cannot run SAINT.&#39;</span><span class="p">]),{},</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;generate_saint_container: preparations started: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">db_conn</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
    <span class="n">additional_controls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s1">&#39;control_</span><span class="si">{</span><span class="n">ctrl_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">ctrl_name</span> <span class="ow">in</span> <span class="n">additional_controls</span><span class="p">]</span>
    <span class="n">crapomes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s1">&#39;crapome_</span><span class="si">{</span><span class="n">crap_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">crap_name</span> <span class="ow">in</span> <span class="n">crapomes</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;generate_saint_container: DB connected&#39;</span><span class="p">)</span>
    <span class="n">spc_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">control_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">spc_table</span><span class="p">,</span> <span class="n">control_table</span> <span class="o">=</span> <span class="n">prepare_controls</span><span class="p">(</span>
        <span class="n">input_data_dict</span><span class="p">,</span> <span class="n">uploaded_controls</span><span class="p">,</span> <span class="n">additional_controls</span><span class="p">,</span> <span class="n">db_conn</span><span class="p">,</span> <span class="n">select_most_similar_only</span><span class="p">,</span> <span class="n">n_controls</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;generate_saint_container: Controls prepared&#39;</span><span class="p">)</span>
    <span class="n">protein_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span><span class="n">spc_table</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">control_table</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
    <span class="n">protein_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">db_functions</span><span class="o">.</span><span class="n">get_from_table</span><span class="p">(</span>
        <span class="n">db_conn</span><span class="p">,</span>
        <span class="s1">&#39;proteins&#39;</span><span class="p">,</span>
        <span class="n">select_col</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;uniprot_id&#39;</span><span class="p">,</span>
            <span class="s1">&#39;length&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gene_name&#39;</span>
        <span class="p">],</span>
        <span class="n">as_pandas</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;generate_saint_container: Protein table retrieved&#39;</span><span class="p">)</span>
    <span class="n">protein_table</span> <span class="o">=</span> <span class="n">protein_table</span><span class="p">[</span><span class="n">protein_table</span><span class="p">[</span><span class="s1">&#39;uniprot_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
        <span class="n">protein_list</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crapomes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">crapome</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">prepare_crapome</span><span class="p">(</span><span class="n">db_conn</span><span class="p">,</span> <span class="n">crapomes</span><span class="p">)</span>
        <span class="n">crapome</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">crapome</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span>
                     <span class="nb">set</span><span class="p">(</span><span class="n">spc_table</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">crapome</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">db_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">saint_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">make_saint_dict</span><span class="p">(</span>
        <span class="n">spc_table</span><span class="p">,</span> <span class="n">input_data_dict</span><span class="p">[</span><span class="s1">&#39;sample groups&#39;</span><span class="p">][</span><span class="s1">&#39;rev&#39;</span><span class="p">],</span> <span class="n">control_table</span><span class="p">,</span> <span class="n">protein_table</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;generate_saint_container: SAINT dict done: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;interactomics-saint-container&#39;</span><span class="p">,</span>
            <span class="n">children</span><span class="o">=</span><span class="p">[</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;interactomics-saint-filtering-container&#39;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">saint_dict</span><span class="p">,</span>
        <span class="n">crapome</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="saint_filtering">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.saint_filtering">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">saint_filtering</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                   <span class="n">bfdr_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                   <span class="n">crapome_percentage</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                   <span class="n">crapome_fc</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                   <span class="n">do_rescue</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter SAINT output by BFDR and CRAPome thresholds.</span>

<span class="sd">    :param saint_output_json: SAINT output in pandas split-JSON format.</span>
<span class="sd">    :param bfdr_threshold: BFDR threshold for filtering.</span>
<span class="sd">    :param crapome_percentage: CRAPome frequency threshold.</span>
<span class="sd">    :param crapome_fc: CRAPome fold-change threshold for rescue.</span>
<span class="sd">    :param do_rescue: If ``True``, keep preys that pass in any bait.</span>
<span class="sd">    :returns: Filtered SAINT output JSON.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">saint_output</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
        <span class="n">StringIO</span><span class="p">(</span><span class="n">saint_output_json</span><span class="p">),</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;saint filtering - beginning: </span><span class="si">{</span><span class="n">saint_output</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;saint filtering - beginning nodupes: </span><span class="si">{</span><span class="n">saint_output</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">saint_output</span> <span class="o">=</span> <span class="n">saint_output</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">crapome_columns</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">saint_output</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;_frequency&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
            <span class="n">crapome_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;_spc_avg&#39;</span><span class="p">)))</span>
    <span class="n">keep_col</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bfdr_disc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">crapome_disc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">keep_preys</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">saint_output</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">keep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;BFDR&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bfdr_threshold</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">bfdr_disc</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="s1">&#39;Max crapome frequency&#39;</span> <span class="ow">in</span> <span class="n">saint_output</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Max crapome frequency&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">crapome_percentage</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">freq_col</span><span class="p">,</span> <span class="n">fc_col</span> <span class="ow">in</span> <span class="n">crapome_columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">freq_col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">crapome_percentage</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">fc_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">crapome_fc</span><span class="p">:</span>
                            <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">crapome_disc</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">break</span>
        <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
            <span class="n">keep_preys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Prey&#39;</span><span class="p">])</span>
        <span class="n">keep_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;saint filtering - Preys pass filter: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">keep_preys</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">saint_output</span><span class="p">[</span><span class="s1">&#39;Passes filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keep_col</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;saint filtering - Saint output pass filter: </span><span class="si">{</span><span class="n">saint_output</span><span class="p">[</span><span class="s2">&quot;Passes filter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">saint_output</span><span class="p">[</span><span class="s1">&#39;Passes filter with rescue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">saint_output</span><span class="p">[</span><span class="s1">&#39;Prey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
        <span class="n">keep_preys</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;saint filtering - Saint output pass filter with rescue: </span><span class="si">{</span><span class="n">saint_output</span><span class="p">[</span><span class="s2">&quot;Passes filter with rescue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">do_rescue</span><span class="p">:</span>
        <span class="n">use_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Passes filter with rescue&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">use_col</span> <span class="o">=</span> <span class="s1">&#39;Passes filter&#39;</span>
    <span class="n">filtered_saint_output</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">saint_output</span><span class="p">[</span>
        <span class="n">saint_output</span><span class="p">[</span><span class="n">use_col</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;saint filtering - filtered size: </span><span class="si">{</span><span class="n">filtered_saint_output</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;Bait uniprot&#39;</span> <span class="ow">in</span> <span class="n">filtered_saint_output</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">filtered_saint_output</span> <span class="o">=</span> <span class="n">filtered_saint_output</span><span class="p">[</span>
            <span class="n">filtered_saint_output</span><span class="p">[</span><span class="s1">&#39;Prey is bait&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span>
        <span class="p">]</span>
    <span class="n">colorder</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bait&#39;</span><span class="p">,</span> <span class="s1">&#39;Bait uniprot&#39;</span><span class="p">,</span> <span class="s1">&#39;Prey&#39;</span><span class="p">,</span> <span class="s1">&#39;PreyGene&#39;</span><span class="p">,</span> <span class="s1">&#39;Prey is bait&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Passes filter&#39;</span><span class="p">,</span> <span class="s1">&#39;Passes filter with rescue&#39;</span><span class="p">,</span> <span class="s1">&#39;AvgSpec&#39;</span><span class="p">]</span>
    <span class="n">colorder</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">filtered_saint_output</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">colorder</span><span class="p">])</span>
    <span class="n">filtered_saint_output</span> <span class="o">=</span> <span class="n">filtered_saint_output</span><span class="p">[</span><span class="n">colorder</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;saint filtering - bait removed filtered size: </span><span class="si">{</span><span class="n">filtered_saint_output</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;saint filtering - bait removed filtered size nodupes: </span><span class="si">{</span><span class="n">filtered_saint_output</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_saint_output</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_saint_matrix">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.get_saint_matrix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_saint_matrix</span><span class="p">(</span><span class="n">saint_data_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert SAINT output JSON to prey x bait matrix of AvgSpec.</span>

<span class="sd">    :param saint_data_json: SAINT output in pandas split-JSON format.</span>
<span class="sd">    :returns: Pivot table DataFrame (rows=Prey, cols=Bait, values=AvgSpec).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">saint_data_json</span><span class="p">),</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Prey&#39;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Bait&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s1">&#39;AvgSpec&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="saint_counts">
<a class="viewcode-back" href="../../../code/app.components.html#app.components.interactomics.saint_counts">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">saint_counts</span><span class="p">(</span><span class="n">filtered_output_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                <span class="n">figure_defaults</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
                <span class="n">replicate_colors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Count prey per bait and plot as a bar chart.</span>

<span class="sd">    :param filtered_output_json: Filtered SAINT output in pandas split-JSON format.</span>
<span class="sd">    :param figure_defaults: Figure defaults for plotting.</span>
<span class="sd">    :param replicate_colors: Mapping ``&#39;sample groups&#39;`` -&gt; color.</span>
<span class="sd">    :returns: Tuple of (bar plot Div, count data JSON).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">count_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">filtered_output_json</span><span class="p">),</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)[</span><span class="s1">&#39;Bait&#39;</span><span class="p">]</span><span class="o">.</span>\
        <span class="n">value_counts</span><span class="p">()</span><span class="o">.</span>\
        <span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Prey count&#39;</span><span class="p">)</span>
    <span class="n">count_df</span><span class="p">[</span><span class="s1">&#39;Color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">replicate_colors</span><span class="p">[</span><span class="s1">&#39;sample groups&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">count_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">bar_graph</span><span class="o">.</span><span class="n">bar_plot</span><span class="p">(</span>
            <span class="n">figure_defaults</span><span class="p">,</span>
            <span class="n">count_df</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">hide_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">x_label</span><span class="o">=</span><span class="s1">&#39;Sample group&#39;</span>
        <span class="p">),</span>
        <span class="n">count_df</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Kari Salokas.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>